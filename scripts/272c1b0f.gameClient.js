function centerMainButtons(){centerElement($("#mainButtons")),$("#mountains").css("top",.37*window.innerHeight-$("#mountains").height()/2),$(".leaf").css("left",.65*window.innerWidth+370)}function initMapTypes(){for(var a in gameData.MAP_TYPES){var b=gameData.MAP_TYPES[a];$("#mapType").append('<option value="'+b.id+'" '+("standard"==a?"selected":"")+">"+b.name+"</option>")}}function initMapSizes(){for(var a in gameData.MAP_SIZES){var b=gameData.MAP_SIZES[a];$("#mapSize").append('<option value="'+b.id+'" '+("medium"==a?"selected":"")+">"+b.name+"</option>")}}function initVegetations(){for(var a in gameData.VEGETATION_TYPES){var b=gameData.VEGETATION_TYPES[a];$("#vegetation").append('<option value="'+b.id+'" '+("standard"==a?"selected":"")+">"+b.name+"</option>")}}function initMapInitialResources(){for(var a in gameData.INITIAL_RESOURCES){var b=gameData.INITIAL_RESOURCES[a];$("#initialResources").append('<option value="'+b.id+'" '+("standard"==a?"selected":"")+">"+b.name+"</option>")}}function initVictoryConditions(){for(var a in gameData.VICTORY_CONDITIONS){var b=gameData.VICTORY_CONDITIONS[a];$("#vc1").append('<option value="'+b.id+'" '+("annihilation"==a?"selected":"")+">"+b.name+"</option>")}}function preloadImages(){function a(){for(i=0;i<a.arguments.length;i++)b[i]=new Image,b[i].src=a.arguments[i],b[i].onload=function(){c++,c>=2&&$("#websiteLoading").fadeOut()},$("#imagesPreload").append(b[i])}var b=new Array,c=0;a("assets/montagnes.png",GUI.IMAGES_PATH+"cursor.png",GUI.IMAGES_PATH+"cursor_hover.png",GUI.IMAGES_PATH+"cursor_attack.png",GUI.IMAGES_PATH+"cursor_cross.png",GUI.IMAGES_PATH+"cursor_cross_hover.png",GUI.IMAGES_PATH+"cursor_h.png",GUI.IMAGES_PATH+"cursor_v.png",GUI.IMAGES_PATH+"cursor_sw.png",GUI.IMAGES_PATH+"cursor_se.png")}function isWebGLEnabled(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(a){return!1}}function centerElement(a){a.css("top",(window.innerHeight-a.height())/2),a.css("left",(window.innerWidth-a.width())/2)}function removeWebsiteDom(){$("#website").remove()}function showLoadingScreen(a){$("#labelLoading").html(a),$("#loadingScreen").removeClass("hide"),$("#loadingProgress").css("left",(window.innerWidth-$("#loadingProgress").width())/2)}function initPlayers(){var a="";for(var b in gameData.RACES){var c=gameData.RACES[b];a+='<option value="'+c.id+'">'+c.name+"</option>"}for(var b=0;6>b;b++)b>0?$("#players").append('<div class="player '+(b>3?"hideI":"")+'">Player '+(b+1)+'<div class="customRadio checked" data-name="player'+b+'" data-value="0">Human</div><div class="customRadio" data-name="player'+b+'" data-value="1">AI</div><select class="aiArmy hide">'+a+"</select></div>"):$("#players").append('<div class="player">Player 1<div class="checked">Me</div></div>')}function updatePlayers(a){for(var b=1;7>b;b++)a>=b?$(".player:nth-child("+b+")","#players").removeClass("hideI"):$(".player:nth-child("+b+")","#players").addClass("hideI");$("#newGame").css({background:"#3b423c",background:"-moz-radial-gradient(center, ellipse cover, #3b423c 1%, #000000 100%)",background:"-webkit-gradient(radial, center center, 0px, center center, 100%, color-stop(1%,#3b423c), color-stop(100%,#000000))",background:"-webkit-radial-gradient(center, ellipse cover, #3b423c 1%,#000000 100%)"})}function requestFullScreen(){var a=document.fullScreenElement&&null!==document.fullScreenElement||document.mozFullScreen||document.webkitIsFullScreen,b=document.documentElement;a||(b.webkitRequestFullScreen?b.webkitRequestFullscreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.requestFullscreen&&b.requestFullscreen())}THREE.TrackballControls=function(a,b){function c(a){if(n.enabled!==!1){switch(r=q,a.keyCode){case 8:return!0;case 13:return userInput.pressEnterKey(),!0;case 32:return userInput.pressSpaceKey(),!0;case 38:return m(1,1,!0),!1;case 40:return m(1,-1,!0),!1;case 39:return m(0,-1,!0),!1;case 37:return m(0,1,!0),!1;case 83:if(!GUI.showBuildings)return userInput.pressStopKey(),!0;break;case 72:if(!GUI.showBuildings)return userInput.pressHoldKey(),!0;break;case 80:if(!GUI.showBuildings)return userInput.enterPatrolMode(),!0;break;case 65:if(!GUI.showBuildings)return userInput.enterAttackMode(),!0;break;case 49:return a.preventDefault(),userInput.pressHotKey(0,a.ctrlKey),!0;case 50:return a.preventDefault(),userInput.pressHotKey(1,a.ctrlKey),!0;case 51:return a.preventDefault(),userInput.pressHotKey(2,a.ctrlKey),!0;case 52:return a.preventDefault(),userInput.pressHotKey(3,a.ctrlKey),!0;case 53:return a.preventDefault(),userInput.pressHotKey(4,a.ctrlKey),!0}userInput.isChatWindowOpen||userInput.pressToolbarShortcut(a.keyCode)}}function d(a){if(n.enabled!==!1)switch(q=o.NONE,a.keyCode){case 13:case 38:m(1,0,!0);break;case 40:m(1,0,!0);break;case 39:m(0,0,!0);break;case 37:m(0,0,!0)}}function e(a){n.enabled!==!1&&(a.preventDefault(),a.stopPropagation(),q===o.NONE&&(q=a.button),q===o.ROTATE_ZOOM?n.noRotate?n.noZoom||(v=w=n.getMouseOnScreen(a.clientX,a.clientY)):t=u=n.getMouseProjectionOnBall(a.clientX,a.clientY):q===o.SELECTION?n.clickMode!=n.MODES.normal?(userInput.doAction(a.clientX,a.clientY,a.shiftKey,n.clickMode),userInput.leaveSpecialClickMode()):userInput.doSelect(a.clientX,a.clientY,a.ctrlKey,a.shiftKey):q===o.ACTION&&(n.clickMode!=n.MODES.normal?userInput.leaveSpecialClickMode():userInput.doAction(a.clientX,a.clientY,a.shiftKey,n.clickMode)),document.addEventListener("mouseup",g,!1))}function f(a){n.enabled!==!1&&(a.preventDefault(),a.stopPropagation(),q===o.ROTATE_ZOOM?n.noRotate?n.noZoom||(w=n.getMouseOnScreen(a.clientX,a.clientY)):u=n.getMouseProjectionOnBall(a.clientX,a.clientY):q===o.SELECTION?userInput.drawSelectionRectangle(a.clientX,a.clientY,a.ctrlKey):(a.clientX<n.SCROLL_THRESHOLD?m(0,1,!1):a.clientX>window.innerWidth-n.SCROLL_THRESHOLD?m(0,-1,!1):n.isKeyboardScrolling||0==n.scroll[0]||m(0,0,!1),a.clientY<n.SCROLL_THRESHOLD?m(1,1,!1):a.clientY>window.innerHeight-n.SCROLL_THRESHOLD?m(1,-1,!1):n.isKeyboardScrolling||0==n.scroll[1]||m(1,0,!1),userInput.onMouseMove(a.clientX,a.clientY)),n.mousePosition.x=a.clientX,n.mousePosition.y=a.clientY)}function g(a){n.enabled!==!1&&(a.preventDefault(),a.stopPropagation(),q=o.NONE,userInput.onMouseUp(),document.removeEventListener("mouseup",g))}function h(a){n.enabled!==!1&&(a.preventDefault(),a.stopPropagation(),userInput.doDoubleClick(a.clientX,a.clientY))}function i(a){if(n.enabled!==!1){a.preventDefault(),a.stopPropagation();var b=0;a.wheelDelta?b=a.wheelDelta/40:a.detail&&(b=-a.detail/3),a.shiftKey?(t=n.getMouseProjectionOnBall(a.clientX,a.clientY),u=n.getMouseProjectionOnBall(a.clientX+b*n.WHEEL_ROTATION_SPEED,a.clientY)):v.y+=.01*b}}function j(a){if(n.enabled!==!1)switch(a.touches.length){case 1:q=o.TOUCH_ROTATE,t=u=n.getMouseProjectionOnBall(a.touches[0].pageX,a.touches[0].pageY);break;case 2:q=o.TOUCH_ZOOM;var b=a.touches[0].pageX-a.touches[1].pageX,c=a.touches[0].pageY-a.touches[1].pageY;y=x=Math.sqrt(b*b+c*c);break;case 3:q=o.TOUCH_PAN,z=A=n.getMouseOnScreen(a.touches[0].pageX,a.touches[0].pageY);break;default:q=o.NONE}}function k(a){if(n.enabled!==!1)switch(a.preventDefault(),a.stopPropagation(),a.touches.length){case 1:u=n.getMouseProjectionOnBall(a.touches[0].pageX,a.touches[0].pageY);break;case 2:var b=a.touches[0].pageX-a.touches[1].pageX,c=a.touches[0].pageY-a.touches[1].pageY;y=Math.sqrt(b*b+c*c);break;case 3:A=n.getMouseOnScreen(a.touches[0].pageX,a.touches[0].pageY);break;default:q=o.NONE}}function l(a){if(n.enabled!==!1){switch(a.touches.length){case 1:t=u=n.getMouseProjectionOnBall(a.touches[0].pageX,a.touches[0].pageY);break;case 2:x=y=0;break;case 3:z=A=n.getMouseOnScreen(a.touches[0].pageX,a.touches[0].pageY)}q=o.NONE}}function m(a,b,c){n.scroll[a]=b*n.MAP_SCROLL_SPEED,c&&(n.isKeyboardScrolling=0==b?!1:!0)}var n=this,o={NONE:-1,SELECTION:0,ROTATE_ZOOM:1,ACTION:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5};this.object=a,this.domElement=void 0!==b?b:document,this.enabled=!0,this.screen={width:0,height:0,offsetLeft:0,offsetTop:0},this.radius=(this.screen.width+this.screen.height)/4,this.rotateSpeed=.5,this.panSpeed=.8,this.MODES={normal:order.SPECIAL_ORDERS.normal,attack:order.SPECIAL_ORDERS.attack,patrol:order.SPECIAL_ORDERS.patrol},this.clickMode=this.MODES.normal,this.scroll=[0,0],this.MAP_SCROLL_SPEED=6,this.SCROLL_THRESHOLD=15,this.isKeyboardScrolling=!1,this.zoomSpeed=1.2,this.ZOOM_MAX=30,this.ZOOM_MIN=350,this.WHEEL_ROTATION_SPEED=40,this.ANGLE_ROTATION_MIN=.005,this.PAN_LIMITS=[-100,-100,gameContent.map.size.x*gameSurface.PIXEL_BY_NODE+100,gameContent.map.size.y*gameSurface.PIXEL_BY_NODE+100],this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!0,this.dynamicDampingFactor=.3,this.minDistance=0,this.maxDistance=1/0,this.mousePosition={},this.target=new THREE.Vector3;var p=new THREE.Vector3,q=o.NONE,r=o.NONE,s=new THREE.Vector3,t=new THREE.Vector3,u=new THREE.Vector3,v=new THREE.Vector2,w=new THREE.Vector2,x=0,y=0,z=new THREE.Vector2,A=new THREE.Vector2;_oldEye=null,_oldUp=null,_oldTarget=null,_oldRotateStart=null,this.KEYBOARD_SHORTCUTS=[81,87,69,82,65,83,68,70],this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var B={type:"change"};this.handleResize=function(){this.screen.width=window.innerWidth,this.screen.height=window.innerHeight,this.screen.offsetLeft=0,this.screen.offsetTop=0,this.radius=(this.screen.width+this.screen.height)/4},this.handleEvent=function(a){"function"==typeof this[a.type]&&this[a.type](a)},this.getMouseOnScreen=function(a,b){return new THREE.Vector2((a-n.screen.offsetLeft)/n.radius*.5,(b-n.screen.offsetTop)/n.radius*.5)},this.getMouseProjectionOnBall=function(a,b){var c=new THREE.Vector3((a-.5*n.screen.width-n.screen.offsetLeft)/n.radius,(.5*n.screen.height+n.screen.offsetTop-b)/n.radius,0),d=c.length();d>1?c.normalize():c.z=Math.sqrt(1-d*d),s.copy(n.object.position).sub(n.target);var e=n.object.up.clone().setLength(c.y);return e.add(n.object.up.clone().cross(s).setLength(c.x)),e.add(s.setLength(c.z)),e},this.rotateCamera=function(){var a=Math.acos(t.dot(u)/t.length()/u.length());if(a>n.ANGLE_ROTATION_MIN){var b=(new THREE.Vector3).crossVectors(t,u).normalize(),c=new THREE.Quaternion;b.x=0,b.y=0,a*=n.rotateSpeed,c.setFromAxisAngle(b,-a);var d=s.z;s.applyQuaternion(c),s.multiplyScalar(d/s.z),n.object.up.applyQuaternion(c),n.staticMoving?t.copy(u):(c.setFromAxisAngle(b,a*(n.dynamicDampingFactor-1)),t.applyQuaternion(c))}},this.zoomCamera=function(){if(q===o.TOUCH_ZOOM){var a=x/y;x=y,s.z*a<n.ZOOM_MIN&&s.z*a>n.ZOOM_MAX&&s.multiplyScalar(a)}else{var a=1+(w.y-v.y)*n.zoomSpeed;1!==a&&a>0&&(s.z*a<n.ZOOM_MIN&&s.z*a>n.ZOOM_MAX&&s.multiplyScalar(a),n.staticMoving?v.copy(w):v.y+=(w.y-v.y)*this.dynamicDampingFactor)}},this.panCamera=function(){var a=A.clone().sub(z);if(a.lengthSq()){a.multiplyScalar(s.length()*n.panSpeed);var b=s.clone().cross(new THREE.Vector3(0,0,1)).setLength(n.scroll[0]);b.add(s.clone().multiply(new THREE.Vector3(1,1,0)).setLength(-n.scroll[1])),n.object.position.add(b),n.reachLimits()?n.object.position.sub(b):n.target.add(b),n.staticMoving?z=A:z.add(a.subVectors(A,z).multiplyScalar(n.dynamicDampingFactor))}},this.update=function(){s.subVectors(n.object.position,n.target),_oldEye=s.clone(),_oldUp=n.object.up.clone(),_oldTarget=n.target.clone(),_oldRotateStart=t.clone(),n.noRotate||n.rotateCamera(),n.noZoom||n.zoomCamera(),0!=n.scroll[0]||0!=n.scroll[1]?(z=new THREE.Vector2(n.screen.width/2,n.screen.height/2),A=new THREE.Vector2(n.screen.width/2+n.scroll[0],n.screen.height/2+n.scroll[1]),n.panCamera()):n.noPan||n.panCamera(),n.object.position.addVectors(n.target,s),n.reachLimits()&&(n.object.position.subVectors(n.target,s),s=_oldEye,n.target=_oldTarget,n.object.up=_oldUp,t=_oldRotateStart,n.object.position.addVectors(n.target,_oldEye)),n.object.lookAt(n.target),p.distanceToSquared(n.object.position)>0&&(n.dispatchEvent(B),p.copy(n.object.position))},this.reset=function(){q=o.NONE,r=o.NONE,n.target.copy(n.target0),n.object.position.copy(n.position0),n.object.up.copy(n.up0),s.subVectors(n.object.position,n.target),n.object.lookAt(n.target),n.dispatchEvent(B),p.copy(n.object.position)},this.reachLimits=function(){return n.target.x<n.PAN_LIMITS[0]||n.target.y<n.PAN_LIMITS[1]||n.target.x>n.PAN_LIMITS[2]||n.target.y>n.PAN_LIMITS[3]?!0:!1},this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1),this.domElement.addEventListener("mousedown",e,!1),this.domElement.addEventListener("mousemove",f,!1),this.domElement.addEventListener("dblclick",h,!1),this.domElement.addEventListener("mousewheel",i,!1),this.domElement.addEventListener("DOMMouseScroll",i,!1),this.domElement.addEventListener("touchstart",j,!1),this.domElement.addEventListener("touchend",l,!1),this.domElement.addEventListener("touchmove",k,!1),window.addEventListener("keydown",c,!1),window.addEventListener("keyup",d,!1),this.handleResize()},THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype);var userInput={};userInput.CAN_BE_BUILT_HERE=10,userInput.CANNOT_BE_BUILT_HERE=1,userInput.DOUBLE_CLICK_RADIUS_SIZE=25,userInput.isChatWindowOpen=!1,userInput.hotKeysContent=[[],[],[],[],[]],userInput.doSelect=function(a,b,c,d){var e=GUI.isGUIClicked(a,b);if(e!=GUI.GUI_ELEMENTS.bottomBar){if(e==GUI.GUI_ELEMENTS.minimap)return void GUI.clickOnMinimap(a,b);if(null!=gameContent.building)return this.tryBuildHere(d),!1;this.leaveConstructionMode(),c||(gameSurface.unselectAll(),gameContent.selected=[]),gameContent.selectionRectangle=[],gameSurface.updateSelectionRectangle(-1,-1,-1,-1),gameContent.selectionRectangle[0]=a,gameContent.selectionRectangle[1]=b;var f=gameSurface.getFirstIntersectObject(a,b);if(null!=f&&null!=f.object.elementId&&(c&&gameContent.selected.indexOf(f.object.elementId)>-1?(gameContent.selected.splice(gameContent.selected.indexOf(f.object.elementId),1),gameSurface.unselectElement(f.object.elementId)):(gameContent.selected.push(f.object.elementId),gameSurface.selectElement(f.object.elementId))),gameContent.selected.length>1)for(var g in gameContent.selected){var h=""+gameContent.selected[g];if(parseInt(h.charAt(1))==gameData.FAMILIES.land){gameSurface.unselectElement(gameContent.selected[g]),gameContent.selected.splice(g,1);break}}return!0}},userInput.doAction=function(a,b,c,d){var e=GUI.isGUIClicked(a,b);if(e!=GUI.GUI_ELEMENTS.bottomBar)if(null!=gameContent.building)this.leaveConstructionMode();else if(gameContent.selected.length>0){var f=utils.getElementFromId(gameContent.selected[0]);if(rank.isAlly(gameContent.players,gameContent.myArmy,f)&&(f.f==gameData.FAMILIES.unit||f.f==gameData.FAMILIES.building)){var g=!1,e=GUI.isGUIClicked(a,b);if(e==GUI.GUI_ELEMENTS.minimap){var h=GUI.convertToMinimapPosition(a,b);a=h.x,b=h.y,g=!0}this.dispatchUnitAction(a,b,c,d,g)}}},userInput.doDoubleClick=function(a,b){if(gameContent.selected.length>0&&GUI.isGUIClicked(a,b)==GUI.GUI_ELEMENTS.none){var c=utils.getElementFromId(gameContent.selected[0]);if(rank.isAlly(gameContent.players,gameContent.myArmy,c)){var d=tools.getTilesAround(gameContent.grid,c.p,this.DOUBLE_CLICK_RADIUS_SIZE,!0);for(var e in d)if(d[e]>0){var f=utils.getElementFromId(d[e]);-1==gameContent.selected.indexOf(f.id)&&f.f==c.f&&rank.isAlly(gameContent.players,gameContent.myArmy,f)&&f.t==c.t&&(gameContent.selected.push(f.id),gameSurface.selectElement(f.id))}}}},userInput.pressToolbarShortcut=function(a){for(var b in GUI.toolbar)GUI.toolbar[b].isEnabled&&GUI.toolbar[b].shortcut==a&&this.clickSpecialButton(GUI.toolbar[b].id)},userInput.pressEnterKey=function(){if(this.isChatWindowOpen){$("#chat").addClass("hide");var a=$("input","#chat").val();""!=a&&("/soundon"==a?(gameManager.musicEnabled=!0,soundManager.playMusic(),gameSurface.showMessage(gameSurface.MESSAGES.musicEnabled)):"/soundoff"==a?(gameManager.musicEnabled=!1,soundManager.stopMusic(),gameSurface.showMessage(gameSurface.MESSAGES.musicDisabled)):"/surrender"==a?gameManager.sendOrderToEngine(order.TYPES.surrender,[gameContent.myArmy]):"/help"==a?$("#helpModal").modal("show"):gameManager.sendOrderToEngine(order.TYPES.chat,[gameContent.myArmy,$("input","#chat").val()])),$("input","#chat").val("")}else $("#chat").removeClass("hide"),$("#chat").css("top",(window.innerHeight-$("#chat").height())/2),$("#chat").css("left",(window.innerWidth-$("#chat").width())/2),$("input","#chat")[0].focus();this.isChatWindowOpen=!this.isChatWindowOpen},userInput.pressSpaceKey=function(){this.isChatWindowOpen||gameContent.selected.length>0&&gameSurface.centerCameraOnElement(utils.getElementFromId(gameContent.selected[0]))},userInput.onMouseMove=function(a,b){this.updateConstructionMode(a,b),this.updateMouseIcon(a,b)},userInput.onMouseUp=function(){this.removeSelectionRectangle()},userInput.clickSpecialButton=function(a){if(soundManager.playSound(soundManager.SOUNDS_LIST.button),a==gameData.BUTTONS.build.id)this.highlightButton(a),GUI.showBuildings=!0;else if(a==gameData.BUTTONS.back.id)this.highlightButton(a),GUI.showBuildings=!1;else if(a==gameData.BUTTONS.cancel.id)this.highlightButton(a),gameManager.sendOrderToEngine(order.TYPES.cancelConstruction,[utils.getElementFromId(gameContent.selected[0]).id]);else if(GUI.showBuildings){var b=gameData.ELEMENTS[gameData.FAMILIES.building][gameContent.players[gameContent.myArmy].r],c=b[Object.keys(b)[(""+a)[2]]];this.enterConstructionMode(c)}else if(utils.getElementFromId(gameContent.selected[0]).f==gameData.FAMILIES.building){var d,e=(""+a)[0];if(e==gameData.FAMILIES.unit){var f=gameData.ELEMENTS[gameData.FAMILIES.unit][gameContent.players[gameContent.myArmy].r];d=f[Object.keys(f)[(""+a)[2]]]}else{var g=gameData.ELEMENTS[gameData.FAMILIES.research][gameContent.players[gameContent.myArmy].r];d=g[(""+a).substring(2)]}this.highlightButton(a),gameManager.sendOrderToEngine(order.TYPES.buy,[gameContent.selected,d])}},userInput.highlightButton=function(a){var b=$('button[data-id="'+a+'"]',"#toolbar");b.addClass("selected"),setTimeout(function(){b.removeClass("selected")},150)},userInput.enterConstructionMode=function(a){gameContent.building=a,GUI.selectButton(a),this.updateConstructionMode(controls.mousePosition.x,controls.mousePosition.y)},userInput.updateConstructionMode=function(a,b){if(null!=gameContent.building){gameContent.building.p=gameSurface.getAbsolutePositionFromPixel(a,b),gameContent.building.canBeBuiltHere=!0;for(var c in gameContent.building.shape)for(var d in gameContent.building.shape[c])gameContent.building.shape[c][d]=this.CAN_BE_BUILT_HERE;utils.canBeBuiltHere(gameContent.building),gameSurface.updateBuildingGeometry()}},userInput.leaveConstructionMode=function(){gameContent.building=null,gameSurface.removeBuildingGeometry(),GUI.unselectButtons(),GUI.showBuildings=!1},userInput.updateMouseIcon=function(a,b){var c=gameSurface.getFirstIntersectObject(a,b),d=-controls.scroll[0],e=controls.scroll[1];if(null!=c&&null!=c.object.elementId){var f=utils.getElementFromId(c.object.elementId);if(controls.clickMode!=controls.MODES.normal)return void GUI.updateMouse(GUI.MOUSE_ICONS.crossHover);null!=f&&f.f!=gameData.FAMILIES.land&&rank.isEnemy(gameContent.players,gameContent.myArmy,f)?GUI.updateMouse(GUI.MOUSE_ICONS.attack):GUI.updateMouse(GUI.MOUSE_ICONS.select)}else controls.clickMode!=controls.MODES.normal?GUI.updateMouse(GUI.MOUSE_ICONS.cross):controls.isKeyboardScrolling||(d>0&&e>0?GUI.updateMouse(GUI.MOUSE_ICONS.arrowTopRight):d>0&&0==e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowRight):d>0&&0>e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottomRight):0>d&&e>0?GUI.updateMouse(GUI.MOUSE_ICONS.arrowTopLeft):0>d&&0==e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowLeft):0>d&&0>e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottomLeft):0==d&&e>0?GUI.updateMouse(GUI.MOUSE_ICONS.arrowTop):0==d&&0>e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottom):GUI.updateMouse(GUI.MOUSE_ICONS.standard))},userInput.tryBuildHere=function(a){if(gameContent.building.canBeBuiltHere){if(a&&!production.canBuyIt(gameContent.players,gameContent.myArmy,gameContent.building))return void this.leaveConstructionMode();soundManager.playSound(soundManager.SOUNDS_LIST.hammer),gameManager.sendOrderToEngine(order.TYPES.buildThatHere,[gameContent.selected,gameContent.building,gameContent.building.p.x,gameContent.building.p.y,a]),a||this.leaveConstructionMode()}},userInput.dispatchUnitAction=function(a,b,c,d,e){var f=null;if(e)f={x:parseInt(a/gameSurface.PIXEL_BY_NODE),y:parseInt(b/gameSurface.PIXEL_BY_NODE)};else{var g=gameSurface.getFirstIntersectObject(a,b);null!=g&&(null!=g.object.elementId?(f=utils.getElementFromId(g.object.elementId).p,gameSurface.animateSelectionCircle(g.object.elementId)):f={x:parseInt(g.point.x/gameSurface.PIXEL_BY_NODE),y:parseInt(g.point.y/gameSurface.PIXEL_BY_NODE)})}null!=f&&f.x>=0&&f.y>=0&&f.x<gameContent.map.size.x&&f.y<gameContent.map.size.y&&gameManager.sendOrderToEngine(order.TYPES.action,[gameContent.selected,f.x,f.y,c,d])},userInput.drawSelectionRectangle=function(a,b,c){if(gameContent.selectionRectangle.length>0){c||(gameSurface.unselectAll(),gameContent.selected=[]);var d=!1;gameSurface.updateSelectionRectangle(gameContent.selectionRectangle[0],gameContent.selectionRectangle[1],a,b);for(var e=gameSurface.getFirstIntersectObject(gameContent.selectionRectangle[0],gameContent.selectionRectangle[1]).point,f=gameSurface.getFirstIntersectObject(a,b).point,g=gameSurface.convertScenePositionToGamePosition(e),h=gameSurface.convertScenePositionToGamePosition(f),i=[g.x,g.y,h.x,h.y],j=Math.min(i[0],i[2]);j<=Math.max(i[0],i[2]);j++)for(var k=Math.min(i[1],i[3]);k<=Math.max(i[1],i[3]);k++)if(gameContent.grid[j][k]>0){var l=utils.getElementFromId(gameContent.grid[j][k]);rank.isAlly(gameContent.players,gameContent.myArmy,l)&&(c&&-1!=gameContent.selected.indexOf(l.id)||(gameContent.selected.push(l.id),gameSurface.selectElement(l.id),d=!0))}for(var j in gameContent.selected){var m=""+gameContent.selected[j];if(m.charAt(1)==gameData.FAMILIES.unit){for(var n=gameContent.selected.length;n--;){var l=utils.getElementFromId(gameContent.selected[n]);l.f==gameData.FAMILIES.building&&(gameContent.selected.splice(n,1),gameSurface.unselectElement(l.id))}break}}if(d)for(var n=gameContent.selected.length;n--;){var l=utils.getElementFromId(gameContent.selected[n]);l.f==gameData.FAMILIES.land&&(gameContent.selected.splice(n,1),gameSurface.unselectElement(l.id))}}},userInput.removeSelectionRectangle=function(){gameContent.selectionRectangle=[],gameSurface.updateSelectionRectangle(-1,-1,-1,-1)},userInput.pressStopKey=function(){this.isChatWindowOpen||gameContent.selected.length>0&&(gameManager.sendOrderToEngine(order.TYPES.stop,[gameContent.selected]),this.highlightButton("stop"))},userInput.pressHoldKey=function(){this.isChatWindowOpen||gameContent.selected.length>0&&(gameManager.sendOrderToEngine(order.TYPES.hold,[gameContent.selected]),this.highlightButton("hold"))},userInput.enterPatrolMode=function(){this.isChatWindowOpen||gameContent.selected.length>0&&(GUI.unselectButtons(),$("#patrolButton").addClass("selected"),controls.clickMode=controls.MODES.patrol)},userInput.enterAttackMode=function(){this.isChatWindowOpen||gameContent.selected.length>0&&(GUI.unselectButtons(),$("#attackButton").addClass("selected"),controls.clickMode=controls.MODES.attack)},userInput.leaveSpecialClickMode=function(){GUI.unselectButtons(),GUI.updateMouse(GUI.MOUSE_ICONS.standard),controls.clickMode=controls.MODES.normal},userInput.pressHotKey=function(a,b){if(!this.isChatWindowOpen)if(b){this.hotKeysContent[a]=[];for(var c in gameContent.selected)this.hotKeysContent[a].push(gameContent.selected[c])}else{var d=this.hotKeysContent[a].length;if(0==d)return;for(;d--;)null==utils.getElementFromId(this.hotKeysContent[a][d])&&this.hotKeysContent[a].splice(d,1);gameContent.selected.length==this.hotKeysContent[a].length&&this.hotKeysContent[a].indexOf(gameContent.selected[0])>-1&&gameSurface.centerCameraOnElement(utils.getElementFromId(gameContent.selected[0])),gameSurface.unselectAll(),gameContent.selected=[];for(var c in this.hotKeysContent[a])gameContent.selected.push(this.hotKeysContent[a][c]),gameSurface.selectElement(this.hotKeysContent[a][c])}},userInput.cancelQueue=function(a){gameManager.sendOrderToEngine(order.TYPES.cancelQueue,[gameContent.selected[0],a])};var GUI={};GUI.toolbar=[],GUI.IMAGES_PATH="assets/GUI/",GUI.MOUSE_ICONS={standard:'url("'+GUI.IMAGES_PATH+'cursor.png"), auto',select:'url("'+GUI.IMAGES_PATH+'cursor_hover.png"), auto',attack:'url("'+GUI.IMAGES_PATH+'cursor_attack.png"), auto',cross:'url("'+GUI.IMAGES_PATH+'cursor_cross.png"), auto',crossHover:'url("'+GUI.IMAGES_PATH+'cursor_cross_hover.png"), auto',arrowTop:'url("'+GUI.IMAGES_PATH+'cursor_v.png"), auto',arrowTopRight:'url("'+GUI.IMAGES_PATH+'cursor_sw.png"), auto',arrowTopLeft:'url("'+GUI.IMAGES_PATH+'cursor_se.png"), auto',arrowBottom:'url("'+GUI.IMAGES_PATH+'cursor_v.png"), auto',arrowBottomRight:'url("'+GUI.IMAGES_PATH+'cursor_se.png"), auto',arrowBottomLeft:'url("'+GUI.IMAGES_PATH+'cursor_sw.png"), auto',arrowRight:'url("'+GUI.IMAGES_PATH+'cursor_h.png"), auto',arrowLeft:'url("'+GUI.IMAGES_PATH+'cursor_h.png"), auto'},GUI.UPDATE_FREQUENCY=.2,GUI.GUI_ELEMENTS={none:0,bottomBar:1,minimap:2},GUI.showBuildings=!1,GUI.minimapSize=0,GUI.init=function(){this.initMinimapSize(),this.initResourcesBar(),this.initCommonButtonsEvents(),this.initSpecialButtons(),this.initInfobarEvents(),$("#gui").tooltip({selector:".enableTooltip"}),$.extend($.fn.tooltip.defaults,{animation:!1,html:!0})},GUI.update=function(){this.updatePopulation(),this.updateResources(),this.updateToolbar(),this.updateInfoBar()},GUI.initResourcesBar=function(){for(var a in gameData.RESOURCES){var b=gameData.RESOURCES[a];$("#topBar").append('<div id="resource'+b.id+'"><div class="sprite"></div><span>0</span></div>')}},GUI.initCommonButtonsEvents=function(){$("#attackButton").click(function(){userInput.enterAttackMode()}),$("#stopButton").click(function(){userInput.pressStopKey()}),$("#holdButton").click(function(){userInput.pressHoldKey()}),$("#patrolButton").click(function(){userInput.enterPatrolMode()})},GUI.initSpecialButtons=function(){$("#specialButtons").on("click","button",function(){if(!$(this).hasClass("disabled")){var a=$(this).attr("data-id");userInput.clickSpecialButton(a)}}),$("#queueBuilding").on("click","button",function(){var a=$(this).attr("data-id");userInput.cancelQueue(a)})},GUI.initInfobarEvents=function(){$("#listSelected").on("click","button",function(a){var b=parseInt($(this).attr("data-id"));a.ctrlKey&&gameContent.selected.indexOf(b)>-1?(gameContent.selected.splice(gameContent.selected.indexOf(b),1),gameSurface.unselectElement(b)):1==gameContent.selected.length?gameSurface.centerCameraOnElement(utils.getElementFromId(b)):(gameSurface.unselectAll(),gameContent.selected=[b],gameSurface.selectElement(b))})},GUI.initMinimapSize=function(){document.getElementById("minimap");this.minimapSize=.12*window.innerWidth},GUI.updatePopulation=function(){var a=gameContent.players[gameContent.myArmy];$("span","#population").html(a.pop.current+" / "+a.pop.max)},GUI.updateResources=function(){var a=gameContent.players[gameContent.myArmy];for(var b in gameData.RESOURCES){var c=gameData.RESOURCES[b];$("span","#resource"+c.id).html(a.re[c.id])}},GUI.updateInfoBar=function(){if(gameContent.selected.length>0){$.each($("button","#listSelected"),function(){-1==gameContent.selected.indexOf(parseInt($(this).attr("data-id")))&&$(this).remove()});for(var a in gameContent.selected){var b=utils.getElementFromId(gameContent.selected[a]),c=tools.getElementData(b),d=$('button[data-id="'+b.id+'"]',"#listSelected");0==d.length?$("#listSelected").append('<button data-id="'+b.id+'" class="'+gameSurface.getLifeBarBackgroundColor(b.l/c.l)+'"><div class="'+c.g+' sprite"></div></button>'):d.attr("class",gameSurface.getLifeBarBackgroundColor(b.l/c.l))}var b=utils.getElementFromId(gameContent.selected[0]),c=tools.getElementData(b);if($("#nameElement").html(c.name),b.f==gameData.FAMILIES.land)$("#lifeElement").html(""),$(".landOnly").removeClass("hideI"),$(".unitOnly").addClass("hideI"),$("#defenseStat").addClass("hideI"),$("#popStat").addClass("hideI"),$("#queueBuilding").addClass("hideI"),b.t==gameData.RESOURCES.wood.id?($("span","#resourcesStatWood").html(b.ra),$("#resourcesStatWood").removeClass("hideI"),$("#resourcesStatWater").addClass("hideI")):b.t==gameData.RESOURCES.gold.id?($("span","#resourcesStatWater").html(b.ra),$("#resourcesStatWood").addClass("hideI"),$("#resourcesStatWater").removeClass("hideI")):($("#resourcesStatWood").addClass("hideI"),$("#resourcesStatWater").addClass("hideI"));else if($(".landOnly").addClass("hideI"),$("#lifeElement").html(b.l+"/"+c.l).attr("class",gameSurface.getLifeBarBackgroundColor(b.l/c.l)+" stat"),$("span","#popStat").html(c.pop),$("#popStat").removeClass("hideI"),b.f==gameData.FAMILIES.building?$("#popStat").attr("data-original-title","Add to Population"):$("#popStat").attr("data-original-title","Population Size"),$("span","#defenseStat").html(accessors.getStat(gameContent.players,b.o,c,fightLogic.STATS_BUFF.defense)),$("#defenseStat").removeClass("hideI"),null!=c.attack?($(".unitOnly").removeClass("hideI"),$("span","#fragsStat").html(b.fr),$("span","#attackStat").html(accessors.getStat(gameContent.players,b.o,c,fightLogic.STATS_BUFF.attack)),$("span","#attackSpeedStat").html(accessors.getStat(gameContent.players,b.o,c,fightLogic.STATS_BUFF.attackSpeed)),$("span","#rangeStat").html(accessors.getStat(gameContent.players,b.o,c,fightLogic.STATS_BUFF.range))):$(".unitOnly").addClass("hideI"),b.f==gameData.FAMILIES.building&&rank.isAlly(gameContent.players,gameContent.myArmy,b)&&b.q.length>0){$("button","#queueBuilding").addClass("hideI");for(var a=0;a<b.q.length;a++){var e=b.q[a],f=null;if(e>=0){var g=gameData.ELEMENTS[gameData.FAMILIES.unit][b.r];f=g[Object.keys(g)[e]]}else f=tools.getElementDataFrom(gameData.FAMILIES.research,b.r,e);0==a&&$("#queueProgress").html(b.qp+"%"),$(".sprite:eq("+a+")","#queueBuilding").attr("class",f.g+" sprite"),$("button:eq("+a+")","#queueBuilding").removeClass("hideI")}$("#queueBuilding").removeClass("hideI")}else $("button","#queueBuilding").addClass("hideI"),$("#queueBuilding").addClass("hideI");$("#infoSelected").removeClass("hideI")}else""!=$("#listSelected").html()&&$("#listSelected").html(""),$("#infoSelected").addClass("hideI")},GUI.updateToolbar=function(){if(gameContent.selected.length>0&&rank.isAlly(gameContent.players,gameContent.myArmy,utils.getElementFromId(gameContent.selected[0]))){var a=utils.getElementFromId(gameContent.selected[0]);a.f==gameData.FAMILIES.building?($("#commonButtons").addClass("hideI"),a.cp<100?this.toolbar=[gameData.BUTTONS.cancel]:this.toolbar=production.getWhatCanBeBought(gameContent.players,a.o,tools.getElementDataFrom(gameData.FAMILIES.building,a.r,a.t).buttons)):a.f==gameData.FAMILIES.unit&&(this.showBuildings?($("#commonButtons").addClass("hideI"),this.toolbar=this.getBuildingButtons(a)):($("#commonButtons").removeClass("hideI"),this.toolbar=tools.getElementDataFrom(gameData.FAMILIES.unit,a.r,a.t).buttons)),$("#specialButtons").removeClass("hideI")}else this.toolbar=[],$("#commonButtons").addClass("hideI"),$("#specialButtons").addClass("hideI");$("#specialButtons button").addClass("hide");for(var b in this.toolbar){var c=this.toolbar[b];this.createToolbarButton(c)}},GUI.isGUIClicked=function(a,b){return b>window.innerHeight-120&&a<window.innerWidth-this.minimapSize?this.GUI_ELEMENTS.bottomBar:a>window.innerWidth-this.minimapSize&&b>window.innerHeight-this.minimapSize?this.GUI_ELEMENTS.minimap:this.GUI_ELEMENTS.none},GUI.clickOnMinimap=function(a,b){var c=this.convertToMinimapPosition(a,b);gameSurface.centerCameraOnPosition(c)},GUI.convertToMinimapPosition=function(a,b){return{x:parseInt(gameContent.map.size.x*gameSurface.PIXEL_BY_NODE*(this.minimapSize-window.innerWidth+a)/this.minimapSize),y:parseInt(gameContent.map.size.y*gameSurface.PIXEL_BY_NODE*(window.innerHeight-b)/this.minimapSize)}},GUI.fromRealToMinimapPosition=function(a,b){var c={x:parseInt(a/(gameContent.map.size.x*gameSurface.PIXEL_BY_NODE)*this.minimapSize),
y:parseInt(b/(gameContent.map.size.y*gameSurface.PIXEL_BY_NODE)*this.minimapSize)};return c.x<0?c.x=0:c.x>this.minimapSize-1&&(c.x=this.minimapSize-1),c.y<0?c.y=0:c.y>this.minimapSize-1&&(c.y=this.minimapSize-1),c},GUI.getBuildingButtons=function(a){return production.getWhatCanBeBought(gameContent.players,a.o,gameData.ELEMENTS[gameData.FAMILIES.building][a.r])},GUI.updateMouse=function(a){document.body.style.cursor=a},GUI.createToolbarButton=function(a){if(null!=$("#toolbar"+a.id).html())$("#toolbar"+a.id).removeClass("hide");else{var b;b=null!=a.needs&&a.needs.length>0?"<p>"+a.tooltip+"</p>":a.tooltip;for(var c in a.needs){var d=a.needs[c];b+=d.t>=0?'<p class="price"><span class="'+gameData.RESOURCES[Object.keys(gameData.RESOURCES)[d.t]].image+' sprite">&nbsp;</span>'+d.value+"</p>":'<p class="technoNeed">'+d.t+"</p>"}var e='<button id="toolbar'+a.id+'" data-id="'+a.id+'" class="enableTooltip" data-toggle="tooltip" title=\''+b+"'><div class=\""+a.g+' sprite"></div></button>';$("#specialButtons").append(e)}a.isEnabled?$("#toolbar"+a.id).removeClass("disabled"):$("#toolbar"+a.id).addClass("disabled")},GUI.selectButton=function(a){this.unselectButtons(),$('button[data-id="'+a.id+'"]',"#toolbar").addClass("selected")},GUI.unselectButtons=function(){$("button","#toolbar").removeClass("selected")};var gameSurface={},scene,camera,controls;THREE.ShaderLib.lambert.fragmentShader=THREE.ShaderLib.lambert.fragmentShader.replace(/^\s\s*/,"").replace(/\s\s*$/,""),THREE.ShaderLib.lambert.fragmentShader="uniform vec3 diffuse;\n"+THREE.ShaderLib.lambert.fragmentShader.substr(0,THREE.ShaderLib.lambert.fragmentShader.length-1),THREE.ShaderLib.lambert.fragmentShader+=["#ifdef USE_MAP","	gl_FragColor = texture2D( map, vUv );","#else","	gl_FragColor = vec4(diffuse, 1.0);","#endif","	vec3 basecolor = vec3(gl_FragColor[0], gl_FragColor[1], gl_FragColor[2]);","	float alpha = gl_FragColor[3];","	float vlf = vLightFront[0];","	if (vlf< 0.50) { gl_FragColor = vec4(mix( basecolor, vec3(0.0), 0.5), alpha); }","	if (vlf>=0.50) { gl_FragColor = vec4(mix( basecolor, vec3(0.0), 0.3), alpha); }","	if (vlf>=0.75) { gl_FragColor = vec4(mix( basecolor, vec3(1.0), 0.0), alpha); }","}"].join("\n"),gameSurface.MODELS_PATH="assets/3D/",gameSurface.PIXEL_BY_NODE=10,gameSurface.NEAR=.1,gameSurface.FAR=2e4,gameSurface.ZOOM_STEP=15,gameSurface.ORDER_ANIMATION_SPEED=.08,gameSurface.ORDER_ROTATION_SPEED=1/12,gameSurface.ORDER_SIZE_MAX=.9,gameSurface.ORDER_SIZE_MIN=.5,gameSurface.ORDER_OPACITY=.7,gameSurface.FOG_DENSITY=5e-4,gameSurface.SELECTION_ENEMY_COLOR="#f00",gameSurface.SELECTION_ALLY_COLOR="#0f0",gameSurface.SELECTION_NEUTRAL_COLOR="#e3e314",gameSurface.CAMERA_INIT_ANGLE=.7,gameSurface.CAN_BUILD_CUBE_COLOR=65280,gameSurface.CANNOT_BUILD_CUBE_COLOR=16711680,gameSurface.BUILD_CUBE_OPACITY=.4,gameSurface.CENTER_CAMERA_Y_OFFSET=40*gameSurface.PIXEL_BY_NODE,gameSurface.BARS_HEIGHT=.5,gameSurface.BARS_DEPTH=.2,gameSurface.BUILDING_STRUCTURE_SIZE=5,gameSurface.BUILDING_INIT_Z=-2*gameSurface.PIXEL_BY_NODE,gameSurface.ARMIES_COLORS=["_red","_blu","_gre","_yel"],gameSurface.PLAYERS_COLORS=["red","blue","green","yellow"],gameSurface.PLAYERS_COLORS_RGB=[{r:255,g:0,b:0},{r:50,g:50,b:255},{r:25,g:255,b:0},{r:255,g:255,b:0}],gameSurface.MOVEMENT_EXTRAPOLATION_ITERATION=50/gameLogic.FREQUENCY,gameSurface.LAND_HEIGHT_SMOOTH_FACTOR=65,gameSurface.FOG_OF_WAR_HEIGHT=10,gameSurface.FOG_OF_WAR_UNCOVERED_HEIGHT=-20,gameSurface.DEEP_FOG_OF_WAR_HEIGHT=18,gameSurface.DEEP_FOG_OF_WAR_UNCOVERED_HEIGHT=-19,gameSurface.iteration=0,gameSurface.geometries=null,gameSurface.materials=null,gameSurface.isKeyboardScrolling=!1,gameSurface.stuffLoaded=0,gameSurface.totalStuffToLoad=0,gameSurface.ex=[],gameSurface.orderFactor=-1,gameSurface.loader=null,gameSurface.projector=null,gameSurface.order=null,gameSurface.canBuildHereMaterial=null,gameSurface.cannotBuildHereMaterial=null,gameSurface.basicCubeGeometry=null,gameSurface.building=null,gameSurface.skybox=null,gameSurface.animations=[],gameSurface.clock=null,gameSurface.elementsMemorizedInFog=[],gameSurface.fogOfWarMatrix=null,gameSurface.deepFogOfWarMatrix=null,gameSurface.fogOfWarGroundTexture,gameSurface.fogOfWarDataColor,gameSurface.mapTexture,gameSurface.mapDataColor,gameSurface.minimapCanvas,gameSurface.minimapContext,gameSurface.minimapData,gameSurface.planeSurface,gameSurface.transparentSurface,gameSurface.goldSurface,gameSurface.cameraMinimapPosition={x:0,y:0},gameSurface.cameraMinimapAngle=0,gameSurface.cameraVisionCorners=[0,0,0,0];var chibre=0;gameSurface.init=function(){this.clock=new THREE.Clock,$("#labelLoading").html("Loading"),scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(25,window.innerWidth/window.innerHeight,this.NEAR,this.FAR),controls=new THREE.TrackballControls(camera),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.sortObjects=!1,document.body.appendChild(renderer.domElement),this.projector=new THREE.Projector,this.geometries={},this.materials={},this.loader=new THREE.JSONLoader,this.totalStuffToLoad+=1,this.totalStuffToLoad+=2;var a=[];for(var b in gameContent.players){var c=2,d=parseInt(gameContent.players[b].r);-1==a.indexOf(d)&&(a.push(d),c=3),this.totalStuffToLoad+=Object.keys(gameData.ELEMENTS[gameData.FAMILIES.unit][d]).length*c,this.totalStuffToLoad+=Object.keys(gameData.ELEMENTS[gameData.FAMILIES.building][d]).length*c}this.totalStuffToLoad+=3*(Object.keys(gameData.ELEMENTS[gameData.FAMILIES.land][0]).length-1),this.totalStuffToLoad+=6,this.createScene(),this.init3DModels(),this.minimapCanvas=$("#minimap")[0],this.minimapCanvas.width=gameContent.map.size.x,this.minimapCanvas.height=gameContent.map.size.y,this.minimapContext=this.minimapCanvas.getContext("2d"),this.minimapData=this.minimapContext.getImageData(0,0,this.minimapCanvas.width,this.minimapCanvas.height),window.addEventListener("resize",this.onWindowResize,!1),this.loop()},gameSurface.addSkybox=function(){var a={folder:this.MODELS_PATH+"skyboxes/",skyboxName:"comawhite",filetype:".jpg",size:1e4},b=[];["x","y","z"].forEach(function(c){b.push(a.folder+a.skyboxName+"_"+c+"pos"+a.filetype),b.push(a.folder+a.skyboxName+"_"+c+"neg"+a.filetype)});var c=[];for(var d in b)c.push(new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(b[d],new THREE.UVMapping,function(){gameSurface.updateLoadingCounter()}),side:THREE.BackSide}));var e=new THREE.MeshFaceMaterial(c),f=new THREE.CubeGeometry(a.size,a.size,a.size);this.skybox=new THREE.Mesh(f,e),this.skybox.rotation.x=this.de2ra(90),scene.add(this.skybox)},gameSurface.createScene=function(){var a=new THREE.SpotLight(16777215);a.position.set(200,200,200),a.rotation.x=a.rotation.y=a.rotation.z=0,a.target.position.set(0,0,0),a.target.updateMatrixWorld(),scene.add(a);var b=new THREE.AmbientLight(8421504);scene.add(b),this.addSkybox();var c=gameContent.map.size.x,d=gameContent.map.size.y,e=c*d;this.fogOfWarDataColor=new Uint8Array(3*e),this.fogOfWarGroundTexture=new THREE.DataTexture(this.fogOfWarDataColor,c,d,THREE.RGBFormat),this.fogOfWarGroundTexture.needsUpdate=!0,this.initHeightMap(),this.transparentSurface=new THREE.Mesh(new THREE.PlaneGeometry(5e3,5e3),new THREE.MeshNormalMaterial({transparent:!0,opacity:0})),this.transparentSurface.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE/2-5,this.transparentSurface.position.y=gameContent.map.size.y*this.PIXEL_BY_NODE/2,this.transparentSurface.position.z=this.planeSurface.position.z-1,scene.add(this.transparentSurface),this.fogOfWarMatrix=[],this.deepFogOfWarMatrix=[];for(var f=0;f<gameContent.map.size.x;f++){this.fogOfWarMatrix[f]=[],this.deepFogOfWarMatrix[f]=[];for(var g=0;g<gameContent.map.size.y;g++)this.fogOfWarMatrix[f][g]=0,this.deepFogOfWarMatrix[f][g]=0}this.order=new THREE.Mesh(new THREE.TorusGeometry(3,.9,2,18),new THREE.LineBasicMaterial({color:"#0f0",opacity:this.ORDER_OPACITY,transparent:!0})),this.order.visible=!1,scene.add(this.order),this.canBuildHereMaterial=new THREE.LineBasicMaterial({color:this.CAN_BUILD_CUBE_COLOR,opacity:this.BUILD_CUBE_OPACITY,transparent:!0}),this.cannotBuildHereMaterial=new THREE.LineBasicMaterial({color:this.CANNOT_BUILD_CUBE_COLOR,opacity:this.BUILD_CUBE_OPACITY,transparent:!0}),this.basicCubeGeometry=new THREE.CubeGeometry(this.PIXEL_BY_NODE,this.PIXEL_BY_NODE,this.PIXEL_BY_NODE),this.building=new THREE.Object3D;for(var h=0;h<this.BUILDING_STRUCTURE_SIZE;h++)for(var i=0;i<this.BUILDING_STRUCTURE_SIZE;i++){var j=new THREE.Mesh(this.basicCubeGeometry,this.canBuildHereMaterial);j.position.x=h*(this.PIXEL_BY_NODE-.5),j.position.y=i*(this.PIXEL_BY_NODE-.5),j.visible=!1,this.building.add(j)}this.building.visible=!1,scene.add(this.building)},gameSurface.initHeightMap=function(){var a=new THREE.ImageUtils.loadTexture(this.MODELS_PATH+"heightmap-"+gameContent.map.size.x+".png");a.wrapS=a.wrapT=THREE.RepeatWrapping,this.bumpScale=100;var b=new THREE.ImageUtils.loadTexture(this.MODELS_PATH+"sand-512.jpg");b.wrapS=b.wrapT=THREE.RepeatWrapping;var c=new THREE.ImageUtils.loadTexture(this.MODELS_PATH+"grass-512.png");c.wrapS=c.wrapT=THREE.RepeatWrapping;var d=new THREE.ImageUtils.loadTexture(this.MODELS_PATH+"rock-512.png");d.wrapS=d.wrapT=THREE.RepeatWrapping,this.grassTexture=b,customUniforms={bumpScale:{type:"f",value:this.bumpScale},bumpTexture:{type:"t",value:a},sandyTexture:{type:"t",value:b},grassTexture:{type:"t",value:c},rockyTexture:{type:"t",value:d},tFog:{type:"t",value:gameSurface.fogOfWarGroundTexture}};var e=new THREE.ShaderMaterial({uniforms:customUniforms,vertexShader:document.getElementById("vertexShader").textContent,fragmentShader:document.getElementById("fragmentShader").textContent});this.landGeometry=new THREE.PlaneGeometry(gameContent.map.size.x*this.PIXEL_BY_NODE,gameContent.map.size.y*this.PIXEL_BY_NODE,100,100),this.planeSurface=new THREE.Mesh(this.landGeometry,e),this.planeSurface.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE/2-5,this.planeSurface.position.y=gameContent.map.size.y*this.PIXEL_BY_NODE/2,this.planeSurface.position.z=-3;var f=new Image;f.src=this.MODELS_PATH+"heightmap-"+gameContent.map.size.x+".png",f.onload=function(){gameSurface.setHeightData(f),scene.add(gameSurface.planeSurface),gameSurface.addBorders()}},gameSurface.addBorders=function(){var a=new THREE.LineBasicMaterial({color:"#000",transparent:!0,opacity:.2});a.side=THREE.DoubleSide;var b=new THREE.PlaneGeometry(gameContent.map.size.x*this.PIXEL_BY_NODE,100,127),c=new THREE.Mesh(b,a);c.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE/2-5,c.position.y=0,c.position.z=gameSurface.planeSurface.position.z,c.rotation.x=Math.PI/2;var d=new THREE.PlaneGeometry(gameContent.map.size.y*this.PIXEL_BY_NODE-12,100,127),e=new THREE.Mesh(d,a);e.position.x=-5,e.position.y=gameContent.map.size.x*this.PIXEL_BY_NODE/2-6,e.position.z=gameSurface.planeSurface.position.z,e.rotation.x=Math.PI/2,e.rotation.y=-Math.PI/2;var f=new THREE.PlaneGeometry(gameContent.map.size.y*this.PIXEL_BY_NODE-12,100,127),g=new THREE.Mesh(f,a);g.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE-5,g.position.y=gameContent.map.size.y*this.PIXEL_BY_NODE/2-6,g.position.z=gameSurface.planeSurface.position.z,g.rotation.x=Math.PI/2,g.rotation.y=-Math.PI/2;var h=new THREE.PlaneGeometry(gameContent.map.size.x*this.PIXEL_BY_NODE,100,127),i=new THREE.Mesh(h,a);i.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE/2-5,i.position.y=gameContent.map.size.y*this.PIXEL_BY_NODE-12,i.position.z=gameSurface.planeSurface.position.z,i.rotation.x=Math.PI/2;for(var j=0;127>j;j++)b.vertices[j].y=height[j][0],d.vertices[j].y=height[0][127-j],f.vertices[j].y=height[0][127-j],h.vertices[j].y=height[j][127];scene.add(c),scene.add(e),scene.add(g),scene.add(i)};var height=[];gameSurface.setHeightData=function(a){var b=document.createElement("canvas");b.id="heightDataCanvas",b.width=a.width,b.height=a.height;var c=b.getContext("2d");a.width*a.height;c.drawImage(a,0,0);var d=c.getImageData(0,0,a.width,a.height),e=d.data,f=gameSurface.landGeometry.vertices,g=-gameContent.map.size.x*gameSurface.PIXEL_BY_NODE/2,h=-g,i=-gameContent.map.size.y*gameSurface.PIXEL_BY_NODE/2,j=-i;for(var k in f){var l=(f[k].x-g)/(h-g)*a.width,m=(f[k].y-i)/(j-i)*a.height,n=4*(Math.floor(l)+Math.floor(m)*a.width);f[k].z=e[n]/255*this.bumpScale}for(var l=0;l<gameContent.map.size.x;l++){height[l]=[];for(var m=0;m<gameContent.map.size.y;m++)height[l][m]=e[4*(l+m*a.width)]/255*this.bumpScale}$("#heightDataCanvas").remove()},gameSurface.init3DModels=function(){for(var a in gameContent.players){for(var b in gameData.ELEMENTS[gameData.FAMILIES.building][gameContent.players[a].r]){var c=gameData.ELEMENTS[gameData.FAMILIES.building][gameContent.players[a].r][b];null!=c.g&&null==this.geometries[c.g]&&(this.geometries[c.g]={},this.loadObject(c.g,gameData.FAMILIES.building,c.r))}for(var b in gameData.ELEMENTS[gameData.FAMILIES.unit][gameContent.players[a].r]){var c=gameData.ELEMENTS[gameData.FAMILIES.unit][gameContent.players[a].r][b];null!=c.g&&null==this.geometries[c.g]&&(this.geometries[c.g]={},this.loadObject(c.g,gameData.FAMILIES.unit,c.r))}}for(var a in gameData.ELEMENTS[gameData.FAMILIES.land][0]){var c=gameData.ELEMENTS[gameData.FAMILIES.land][0][a];null!=c.g&&null==this.geometries[c.g]&&(this.geometries[c.g]={},this.loadObject(c.g,gameData.FAMILIES.land,0))}gameSurface.materials.billboardBar=new THREE.SpriteMaterial({color:16777215,useScreenCoordinates:!1,map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+"fog2.png")})},gameSurface.loadObject=function(a,b,c){if(this.loader.load(this.MODELS_PATH+a+".js",this.geometryLoaded(a)),b!=gameData.FAMILIES.land){for(var d=0;d<gameContent.players.length;d++)if(gameContent.players[d].r==c){var e=this.ARMIES_COLORS[d];gameSurface.materials[a+e]=new THREE.MeshLambertMaterial({lights:!0,map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+a+e+".png",new THREE.UVMapping,function(){gameSurface.updateLoadingCounter()})}),gameSurface.materials["HIDDEN"+a+e]=new THREE.MeshLambertMaterial({lights:!0,color:5592405,map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+a+e+".png",new THREE.UVMapping,function(){gameSurface.updateLoadingCounter()})})}}else gameSurface.materials[a]=new THREE.MeshLambertMaterial({transparent:!0,lights:!0,map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+a+".png",new THREE.UVMapping,function(){gameSurface.updateLoadingCounter()})}),gameSurface.materials["HIDDEN"+a]=new THREE.MeshLambertMaterial({transparent:!0,lights:!0,color:5592405,map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+a+".png",new THREE.UVMapping,function(){gameSurface.updateLoadingCounter()})})},gameSurface.geometryLoaded=function(a){return function(b,c){if(gameSurface.geometries[a]=b,b.animation)for(var d in b.animation)THREE.AnimationHandler.add(b.animation[d]);c&&c.length>0&&(c[0].transparent=!0,c[0].lights=!0,c[0].color=5592405,gameSurface.materials[a]=c[0],gameSurface.materials["HIDDEN"+a]=c[0]),gameSurface.updateLoadingCounter()}},gameSurface.addElement=function(a){var b=tools.getElementData(a),c=b.g;a.f==gameData.FAMILIES.land?(a.material=this.materials[c],a.hiddenMaterial=this.materials["HIDDEN"+c]):(a.material=this.materials[c+this.ARMIES_COLORS[a.o]],a.f==gameData.FAMILIES.building&&(a.hiddenMaterial=this.materials["HIDDEN"+c+this.ARMIES_COLORS[a.o]]));var d;if(this.geometries[c].animation){a.material.skinning=!0,d=new THREE.SkinnedMesh(this.geometries[c],a.material,!1),d.animationKeys={};for(var e in this.geometries[c].animation){var f=this.geometries[c].animation[e],g=new THREE.Animation(d,f.name);d.animationKeys[f.name]=gameSurface.animations.length,gameSurface.animations.push(g)}}else d=new THREE.Mesh(this.geometries[c],a.material);d.elementId=a.id,this.setElementPosition(d,a.p.x,a.p.y),d.rotation.x=this.de2ra(90),("tree"==c||"goldmine"==c)&&(d.rotation.y=this.de2ra(360*Math.random())),gameManager.isOfflineGame?gameContent.gameElements[Object.keys(gameData.FAMILIES)[a.f]][a.id]=a.toJSON():gameContent.gameElements[Object.keys(gameData.FAMILIES)[a.f]][a.id]=a,gameContent.gameElements[Object.keys(gameData.FAMILIES)[a.f]][a.id].m=d,a.f!=gameData.FAMILIES.land&&this.addLifeBar(utils.getElementFromId(a.id)),rank.isAlly(gameContent.players,gameContent.myArmy,a)&&this.showElement(utils.getElementFromId(a.id)),a.f==gameData.FAMILIES.building&&a.cp<100&&(d.position.z=gameSurface.convertGamePositionToScenePosition({x:a.p.x,y:a.p.y}).z+this.BUILDING_INIT_Z),void 0!=d.animationKeys&&(gameSurface.animations[d.animationKeys.standing].play(),d.activeAnimation=d.animationKeys.standing);var h=b.shape;for(var e in h){var i=h[e];for(var j in i){var k=i[j];if(k>0){var l=tools.getPartPosition(a,e,j);gameContent.grid[l.x][l.y]=a.id}}}},gameSurface.updateElement=function(a){var b=utils.getElementFromId(a.id),c=b.m;if(b.f==gameData.FAMILIES.unit){var d=a.p.x-b.p.x,e=a.p.y-b.p.y,f=this.getZPositionFromHeightMap(a.p)-this.getZPositionFromHeightMap(b.p);if(0!=d||0!=e)this.updateOrientation(c,d,e),this.extrapol(c,d,e,f);else if(null!=a.a&&null!=a.a.id){var g=utils.getElementFromId(a.a.id);null!=g&&this.updateOrientation(c,g.p.x-a.p.x,g.p.y-a.p.y)}}var h=tools.getElementData(a);if(a.f==gameData.FAMILIES.building&&(a.cp<100?c.position.z=gameSurface.convertGamePositionToScenePosition({x:a.p.x,y:a.p.y}).z+(100-a.cp)/100*this.BUILDING_INIT_Z:(c.position.z=gameSurface.convertGamePositionToScenePosition({x:a.p.x,y:a.p.y}).z,rank.isAlly(gameContent.players,gameContent.myArmy,a)&&this.updateProgressBar(c,a,h))),a.f!=gameData.FAMILIES.land){for(var i in c.children)if("life"==c.children[i].id){this.updateLifeBar(c.children[i],a,h),c.children[i].rotation.y=-c.rotation.y+this.de2ra(90);break}a.o==gameContent.myArmy&&b.l>a.l}void 0!=c.animationKeys&&(a.fl==gameData.ELEMENTS_FLAGS.moving?c.activeAnimation!=c.animationKeys.move&&(c.activeAnimation>=0&&gameSurface.animations[c.activeAnimation].stop(),gameSurface.animations[c.animationKeys.move].play(),c.activeAnimation=c.animationKeys.move):a.fl==gameData.ELEMENTS_FLAGS.building||a.fl==gameData.ELEMENTS_FLAGS.mining?c.activeAnimation!=c.animationKeys.building&&(c.activeAnimation>=0&&gameSurface.animations[c.activeAnimation].stop(),gameSurface.animations[c.animationKeys.building].play(),c.activeAnimation=c.animationKeys.building):c.activeAnimation!=c.animationKeys.standing&&(c.activeAnimation>=0&&gameSurface.animations[c.activeAnimation].stop(),gameSurface.animations[c.animationKeys.standing].play(),c.activeAnimation=c.animationKeys.standing));var j=h.shape;for(var i in j)for(var k in j[i])if(j[i][k]>0){var l=tools.getPartPosition(b,i,k);gameContent.grid[l.x][l.y]=0}for(var i in j)for(var k in j[i])if(j[i][k]>0){var l=tools.getPartPosition(a,i,k);gameContent.grid[l.x][l.y]=a.id}var m=b.visible,n=b.modelVisible;gameManager.isOfflineGame?gameContent.gameElements[Object.keys(gameData.FAMILIES)[a.f]][a.id]=a.toJSON():gameContent.gameElements[Object.keys(gameData.FAMILIES)[a.f]][a.id]=a,gameContent.gameElements[Object.keys(gameData.FAMILIES)[a.f]][a.id].m=c,gameContent.gameElements[Object.keys(gameData.FAMILIES)[a.f]][a.id].visible=m,gameContent.gameElements[Object.keys(gameData.FAMILIES)[a.f]][a.id].modelVisible=n},gameSurface.removeElement=function(a){a=utils.getElementFromId(a.id),gameContent.selected.indexOf(a.id)>=0&&gameContent.selected.splice(gameContent.selected.indexOf(a.id),1);var b=this.shouldMemorizeInFog(a);b?a.visible&&gameSurface.hideElementModel(a):gameSurface.hideElement(a);var c=tools.getElementData(a),d=c.shape;for(var e in d){var f=d[e];for(var g in f){var h=f[g];if(h>0){var i=tools.getPartPosition(a,e,g);gameContent.grid[i.x][i.y]=0}}}delete gameContent.gameElements[Object.keys(gameData.FAMILIES)[a.f]][a.id]},gameSurface.getAbsolutePositionFromPixel=function(a,b){var c=this.getFirstIntersectObject(a,b,[this.planeSurface]);return null!=c?this.convertScenePositionToGamePosition(c.point):{x:0,y:0}},gameSurface.getAbsolutePositionFromPixelNoBounds=function(a,b){var c=this.getFirstIntersectObject(a,b,[this.transparentSurface]);return null!=c?this.convertScenePositionToGamePositionNoBounds(c.point):{x:0,y:0}},gameSurface.getFirstIntersectObject=function(a,b,c){void 0==c&&(c=scene.children);var d=new THREE.Vector3(a/window.innerWidth*2-1,2*-(b/window.innerHeight)+1,.5);this.projector.unprojectVector(d,camera);var e=new THREE.Raycaster(camera.position,d.sub(camera.position).normalize()),f=e.intersectObjects(c);return f.length>0?f[0]:null},gameSurface.updateCameraViewBounds=function(){this.cameraVisionCorners=[this.getAbsolutePositionFromPixelNoBounds(0,0),this.getAbsolutePositionFromPixelNoBounds(window.innerWidth,0),this.getAbsolutePositionFromPixelNoBounds(window.innerWidth,window.innerHeight),this.getAbsolutePositionFromPixelNoBounds(0,window.innerHeight)]},gameSurface.centerCameraOnElement=function(a){controls.reset();var b=this.convertGamePositionToScenePosition(a.p);camera.position.x=b.x,camera.position.y=b.y-this.CENTER_CAMERA_Y_OFFSET,camera.position.z=controls.ZOOM_MIN,controls.target.x=a.m.position.x,controls.target.y=a.m.position.y,controls.target.z=a.m.position.z},gameSurface.centerCameraOnPosition=function(a){controls.reset(),camera.position.x=a.x,camera.position.y=a.y-this.CENTER_CAMERA_Y_OFFSET,camera.position.z=controls.ZOOM_MIN,controls.target.x=a.x,controls.target.y=a.y,controls.target.z=0},gameSurface.showElement=function(a){a.visible||(a.visible=!0,this.shouldMemorizeInFog(a)&&(index=gameSurface.elementsMemorizedInFog.indexOf(utils.getElementFromId(a.id)))>-1?(this.elementsMemorizedInFog.splice(index,1),utils.getElementFromId(a.id).m.material=a.material):this.showElementModel(a))},gameSurface.hideElement=function(a){a.visible&&(a.visible=!1,this.shouldMemorizeInFog(a)?(this.elementsMemorizedInFog.push(utils.getElementFromId(a.id)),utils.getElementFromId(a.id).m.material=a.hiddenMaterial):this.hideElementModel(a))},gameSurface.showElementModel=function(a){if(!a.modelVisible){a.modelVisible=!0;var b=utils.getElementFromId(a.id).m;scene.add(b)}},gameSurface.hideElementModel=function(a,b){a.modelVisible&&(a.modelVisible=!1,void 0==b&&(b=utils.getElementFromId(a.id).m),scene.remove(b))},gameSurface.manageElementsVisibility=function(){var a=gameContent.map.size.x,b=gameContent.map.size.y,c=[],d=[];for(var e in gameContent.gameElements)for(var f in gameContent.gameElements[e]){var g=gameContent.gameElements[e][f];if(g.f!=gameData.FAMILIES.land&&rank.isAlly(gameContent.players,gameContent.myArmy,g)){var h=g.p.x,i=g.p.y,j=tools.getElementData(g),k=j.vision;g.f==gameData.FAMILIES.building&&g.cp<100&&(k=2);for(var l,m,n,o,p,q=k*k,m=-k;k>=m;m++){n=m*m;for(var l=-k;k>=l;l++)if((p=l*l+n)<=q){var r=Math.sqrt(p);o=r>=.6*k?(k-r)/(.4*k):1,void 0==c[h+l]&&(c[h+l]=[]),(!c[h+l][i+m]||o>c[h+l][i+m])&&(c[h+l][i+m]=o)}}}else d.push(g)}for(;d.length>0;){var g=d.pop();void 0!=c[g.p.x]&&c[g.p.x][g.p.y]?this.showElement(g):this.hideElement(g)}for(index in this.elementsMemorizedInFog){var g=this.elementsMemorizedInFog[index];if(void 0!=c[g.p.x]&&c[g.p.x][g.p.y]>0){if(null==utils.getElementFromId(g.id)){var s=this.elementsMemorizedInFog[index].m;this.hideElementModel(g,s)}else console.log("show it"),this.showElement(g);this.elementsMemorizedInFog.splice(index,1)}}for(var t,u=!1,v=0,w=1,x=2,m=0;b>m;m++)for(var l=0;a>l;l++,v+=3,w+=3,x+=3)t=void 0===c[l]?0:void 0==c[l][m]?0:c[l][m],t!=this.fogOfWarMatrix[l][m]&&(this.fogOfWarMatrix[l][m]=t,t>this.deepFogOfWarMatrix[l][m]?this.deepFogOfWarMatrix[l][m]=t:0!=this.deepFogOfWarMatrix[l][m]&&0==t&&(t=.1),u=!0,this.fogOfWarDataColor[v]=this.fogOfWarDataColor[w]=this.fogOfWarDataColor[x]=Math.round(255*t));u&&(this.fogOfWarGroundTexture.needsUpdate=!0)},gameSurface.shouldMemorizeInFog=function(a){return a.f==gameData.FAMILIES.land||a.f==gameData.FAMILIES.building},gameSurface.updateMinimap=function(){for(var a,b,c,d=0,e=gameContent.map.size.y-1,f=0;e>=f;e--)for(var g=0,h=gameContent.map.size.x;h>g;g++,d+=4){if(0==this.deepFogOfWarMatrix[g][e])a=b=c=0;else{if(0==this.fogOfWarMatrix[g][e]){this.minimapData.data[d+3]=128;continue}var i=gameContent.grid[g][e];if(i>0){var j=utils.getElementFromId(i),k=tools.getElementData(j);if(j.modelVisible&&j.f!=gameData.FAMILIES.land||null!=k.minimapColor){if(j.f==gameData.FAMILIES.land){var l=k.minimapColor;a=l.r,b=l.g,c=l.b}else if(rank.isAlly(gameContent.players,gameContent.myArmy,j))a=b=c=255;else{var l=gameSurface.PLAYERS_COLORS_RGB[j.o];a=l.r,b=l.g,c=l.b}0==this.fogOfWarMatrix[g][e]&&(a/=3,b/=3,c/=3)}}else{var m=Math.max(.1,this.fogOfWarMatrix[g][e]);a=20*m,b=40*m,c=20*m}}this.minimapData.data[d+0]=a,this.minimapData.data[d+1]=b,this.minimapData.data[d+2]=c,this.minimapData.data[d+3]=255}this.minimapContext.putImageData(this.minimapData,0,0);var n=this.minimapContext,o=gameSurface.cameraVisionCorners;n.lineWidth=1,n.strokeStyle="white",n.beginPath(),n.moveTo(o[3].x,gameContent.map.size.y-o[3].y);for(var p=0;4>p;p++)n.lineTo(o[p].x,gameContent.map.size.y-o[p].y);n.stroke()},gameSurface.updateLoadingCounter=function(){this.stuffLoaded++,gameManager.updateLoadingProgress(parseInt(100*this.stuffLoaded/this.totalStuffToLoad)),console.log(this.stuffLoaded+" "+this.totalStuffToLoad)},gameSurface.onWindowResize=function(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight),GUI.initMinimapSize(),controls.handleResize()},gameSurface.loop=function(){var a=gameSurface.clock.getDelta();gameSurface.iteration=gameSurface.iteration>1e3?0:gameSurface.iteration+1,requestAnimationFrame(gameSurface.loop,renderer.domElement),THREE.AnimationHandler.update(a),controls.update(),gameSurface.updateMoveExtrapolation(),TWEEN.update(),renderer.render(scene,camera),gameSurface.iteration%(1/GUI.UPDATE_FREQUENCY)==0&&(gameSurface.updateOrderPosition(),GUI.update(),gameSurface.updateCameraViewBounds(),gameSurface.updateMinimap()),gameSurface.skybox.rotation.y+=gameSurface.de2ra(.01)},gameSurface.setElementPosition=function(a,b,c){var d=this.convertGamePositionToScenePosition({x:b,y:c});a.position.x=d.x,a.position.y=d.y,a.position.z=d.z},gameSurface.convertGamePositionToScenePosition=function(a){return{x:a.x*this.PIXEL_BY_NODE,y:a.y*this.PIXEL_BY_NODE,z:this.getZPositionFromHeightMap(a)}},gameSurface.getZPositionFromHeightMap=function(a){Math.sqrt(this.planeSurface.geometry.vertices.length);return a.x>=0&&a.x<gameContent.map.size.x&&a.y>=0&&a.y<gameContent.map.size.y?height[a.x][a.y]:this.planeSurface.position.z},gameSurface.convertScenePositionToGamePosition=function(a){return{x:Math.min(gameContent.map.size.x-1,Math.max(0,parseInt(a.x/this.PIXEL_BY_NODE))),y:Math.min(gameContent.map.size.y-1,Math.max(0,parseInt(a.y/this.PIXEL_BY_NODE)))}},gameSurface.convertScenePositionToGamePositionNoBounds=function(a){return{x:Math.min(gameContent.map.size.x-1,parseInt(a.x/this.PIXEL_BY_NODE)),y:Math.min(gameContent.map.size.y-1,parseInt(a.y/this.PIXEL_BY_NODE))}},gameSurface.drawSelectionCircle=function(a,b){var c=new THREE.Mesh(new THREE.TorusGeometry(a,.2,2,20*a),new THREE.LineBasicMaterial({color:b,transparent:!0,opacity:.7}));return c.id="select",c.rotation.x=this.de2ra(90),c.scale.x=2,c.scale.y=2,c.scale.z=2,c},gameSurface.drawLifeBar=function(a){var b=tools.getElementData(a),c=this.materials.billboardBar.clone(),d=new THREE.Sprite(c);return d.position.y=2*b.height,d.scale.set(1,1,0),d.id="life",this.updateLifeBar(d,a,b),d},gameSurface.addLifeBar=function(a){var b=this.drawLifeBar(a),c=a.m;c.add(b)},gameSurface.updateLifeBar=function(a,b,c){var d=b.l/c.l;a.scale.x=c.lifeBarWidth*d,a.material.color.setHex(this.getLifeBarColor(d))},gameSurface.updateProgressBar=function(a,b,c){var d=null;for(var e in a.children)if("prog"==a.children[e].id){d=a.children[e];break}if(b.q.length>0&&b.qp>0){if(null==d){var f=this.materials.billboardBar.clone(),d=new THREE.Sprite(f);d.scale.set(1,.6,0),d.position.y=2*c.height-1,d.id="prog",a.add(d)}d.scale.x=c.lifeBarWidth*b.qp/100,d.position.x=-c.lifeBarWidth/4.8+d.scale.x/4.8}else b.qp>=99&&gameContent.players[gameContent.myArmy].pop.current==gameContent.players[gameContent.myArmy].pop.max?this.showMessage(this.MESSAGES.popLimitReached):null!=d&&a.remove(d)},gameSurface.updateOrderPosition=function(){if(gameContent.selected.length>0){var a=utils.getElementFromId(gameContent.selected[0]);if(null==a)return void(this.order.visible=!1);if(null!=a.a&&(null!=a.a.moveTo||null!=a.a.id)||null!=a.rp){var b=null;if(null!=a.rp)b=a.rp;else if(null!=a.a.moveTo)b=a.a.moveTo;else{var c=utils.getElementFromId(a.a.id);if(null==c)return void(this.order.visible=!1);b=c.p}this.setElementPosition(this.order,b.x,b.y),this.order.scale.x>=gameSurface.ORDER_SIZE_MAX?gameSurface.orderFactor=-1:this.order.scale.x<=gameSurface.ORDER_SIZE_MIN&&(gameSurface.orderFactor=1),this.order.scale.x+=this.ORDER_ANIMATION_SPEED*gameSurface.orderFactor,this.order.scale.y+=this.ORDER_ANIMATION_SPEED*gameSurface.orderFactor,this.order.visible=!0}else this.order.visible&&(this.order.visible=!1)}else this.order.visible&&(this.order.visible=!1)},gameSurface.updateSelectionRectangle=function(a,b,c,d){var e=Math.abs(a-c),f=Math.abs(b-d);e>0&&f>0?($("#selectionRectangle").css({top:Math.min(b,d),left:Math.min(a,c),width:e,height:f}),$("#selectionRectangle").removeClass("hide")):$("#selectionRectangle").addClass("hide")},gameSurface.de2ra=function(a){return a*(Math.PI/180)},gameSurface.selectElement=function(a){var b=utils.getElementFromId(a);if(null!=b){var c,d=b.m,e=tools.getElementData(b);c=rank.isEnemy(gameContent.players,gameContent.myArmy,b)?this.SELECTION_ENEMY_COLOR:rank.isAlly(gameContent.players,gameContent.myArmy,b)?this.SELECTION_ALLY_COLOR:this.SELECTION_NEUTRAL_COLOR,d.add(this.drawSelectionCircle((e.f!=gameData.FAMILIES.unit?1.5:1)*e.shape.length/2*this.PIXEL_BY_NODE/2,c))}},gameSurface.unselectElement=function(a){try{for(var b=utils.getElementFromId(a).m,c=b.children.length;c--;){var d=b.children[c];"select"==d.id&&b.remove(d)}}catch(e){}},gameSurface.unselectAll=function(){for(var a in gameContent.selected)this.unselectElement(gameContent.selected[a])},gameSurface.updateOrientation=function(a,b,c){0==b&&0>c?a.rotation.y=this.de2ra(270):b>0&&0>c?a.rotation.y=this.de2ra(315):b>0&&0==c?a.rotation.y=this.de2ra(0):b>0&&c>0?a.rotation.y=this.de2ra(45):0==b&&c>0?a.rotation.y=this.de2ra(90):0>b&&c>0?a.rotation.y=this.de2ra(135):0>b&&0==c?a.rotation.y=this.de2ra(180):0>b&&0>c&&(a.rotation.y=this.de2ra(225)),a.rotation.y+=this.de2ra(90)},gameSurface.updateBuildingGeometry=function(){for(var a in this.building.children)this.building.children[a].visible=!1;var b=gameContent.building.shape;for(var a in b)for(var c in b){var d;if(b[a][c]==userInput.CAN_BE_BUILT_HERE)d=this.canBuildHereMaterial;else{if(b[a][c]!=userInput.CANNOT_BE_BUILT_HERE)continue;d=this.cannotBuildHereMaterial}var e=a*this.BUILDING_STRUCTURE_SIZE+parseInt(c);this.building.children[e].material=d,this.building.children[e].visible=!0}this.setElementPosition(this.building,gameContent.building.p.x-parseInt(b.length/2),gameContent.building.p.y-parseInt(b.length/2)),this.building.visible=!0},gameSurface.removeBuildingGeometry=function(){for(var a in this.building.children)this.building.children[a].visible=!1;this.building.visible=!1},gameSurface.animateSelectionCircle=function(a){this.selectElement(a);var b,c=utils.getElementFromId(a).m;for(var d in c.children)if("select"==c.children[d].id){b=c.children[d];break}var e=new TWEEN.Tween({alpha:1}).delay(300).to({alpha:0},300).onComplete(function(){b.visible=!1}).start(),f=new TWEEN.Tween({alpha:0}).to({alpha:1},300).onComplete(function(){b.visible=!0}),g=new TWEEN.Tween({alpha:0}).to({alpha:1},500).onComplete(function(){gameSurface.unselectElement(a)});e.chain(f),f.chain(g)},gameSurface.getLifeBarColor=function(a){return.25>a?13369344:.5>a?16742144:.75>a?16769280:2726411},gameSurface.getLifeBarBackgroundColor=function(a){return.25>a?"lowLife":.5>a?"mediumLife":.75>a?"highLife":"veryHighLife"},gameSurface.MESSAGES={popLimitReached:{id:0,text:"You need more houses"},musicEnabled:{id:1,text:"Music enabled"},musicDisabled:{id:2,text:"Music disabled"
}},gameSurface.showMessage=function(a,b){$("#messages").removeClass("hide");var c=new Date;$("#messages").append("<div>"+c.getHours()+":"+c.getMinutes()+":"+(c.getSeconds()<10?"0":"")+c.getSeconds()+'<span class="'+(null==b?"white":b)+'">'+a.text+"</span></div>").scrollTop(1e4)},gameSurface.extrapol=function(a,b,c,d){a.ex=b,a.ey=c,a.ez=d,a.et=this.MOVEMENT_EXTRAPOLATION_ITERATION,this.ex.push(a)},gameSurface.updateMoveExtrapolation=function(){for(var a=this.ex.length;a--;){var b=this.ex[a],c=utils.getElementFromId(b.elementId);b.position.x+=b.ex*this.PIXEL_BY_NODE/this.MOVEMENT_EXTRAPOLATION_ITERATION,b.position.y+=b.ey*this.PIXEL_BY_NODE/this.MOVEMENT_EXTRAPOLATION_ITERATION,b.position.z+=b.ez/this.MOVEMENT_EXTRAPOLATION_ITERATION,b.et-=1,b.et<=0&&null!=c&&(this.setElementPosition(b,c.p.x,c.p.y),b.et=0,b.ex=0,b.ey=0,b.ez=0,this.ex.splice(a,1))}};var gameContent={};gameContent.gameId=null,gameContent.map=null,gameContent.players=null,gameContent.myArmy=null,gameContent.isRunning=!1,gameContent.game=null,gameContent.gameElements={land:{},building:{},unit:{}},gameContent.grid=[],gameContent.selected=[],gameContent.building=null,gameContent.selectionRectangle=[],gameContent.init=function(a){for(var b=0;b<this.map.size.x;b++){this.grid[b]=[];for(var c=0;c<this.map.size.y;c++)this.grid[b][c]=0}for(var b in a)for(var c in a[b]){var d=a[b][c];gameSurface.addElement(d),d.f==gameData.FAMILIES.building&&d.o==this.myArmy&&gameSurface.centerCameraOnElement(utils.getElementFromId(d.id))}},gameContent.update=function(a){for(var b in a.added){var c=a.added[b];null==utils.getElementFromId(c.id)&&gameSurface.addElement(c)}for(var b in a.removed){var c=a.removed[b];null!=utils.getElementFromId(c.id)&&gameSurface.removeElement(c)}for(var b in a.modified){var c=a.modified[b];null!=utils.getElementFromId(c.id)&&gameSurface.updateElement(c)}gameSurface.manageElementsVisibility();for(var b in this.players)for(var d in this.players[b].ra)this.players[b].ra[d]!=a.players[b].ra[d]&&this.rankHasChanged(a.players[b],a.players[d]);this.players=a.players,(gameManager.isOfflineGame&&this.players[this.myArmy].s==gameData.PLAYER_STATUSES.victory||this.players[this.myArmy].s==gameData.PLAYER_STATUSES.defeat||this.players[this.myArmy].s==gameData.PLAYER_STATUSES.surrender)&&(gameManager.showStats(this.players[this.myArmy].s,gameContent.game.stats),clearInterval(gameManager.offlineGameLoop));for(var b in a.chat)gameSurface.showMessage({id:parseInt(1e3*Math.random()),text:a.chat[b].text},gameSurface.PLAYERS_COLORS[a.chat[b].o])},gameContent.rankHasChanged=function(a,b){a.ra[b.o]==gameData.RANKS.enemy?gameSurface.showMessage({id:parseInt(1e3*Math.random()),text:a.n+" has declared the war to "+b.n+" !"}):a.ra[b.o]==gameData.RANKS.neutral&&b.ra[a.o]==gameData.RANKS.neutral?gameSurface.showMessage({id:parseInt(1e3*Math.random()),text:a.n+" and "+b.n+" have signed an alliance !"}):a.ra[b.o]==gameData.RANKS.neutral&&gameSurface.showMessage({id:parseInt(1e3*Math.random()),text:a.n+" wants to conclude a pact with "+b.n+"..."})};var utils={};utils.readCookie=function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1,e.length);if(0==e.indexOf(b))return e.substring(b.length,e.length)}return null},utils.createCookie=function(a,b){document.cookie=a+"="+b+"; path=/"},utils.canBeBuiltHere=function(a){for(var b=tools.getPartPosition(a,0,0),c={x:b.x+a.shape[0].length-1,y:b.y+a.shape.length-1},d=b.x;d<=c.x;d++)for(var e=b.y;e<=c.y;e++)(0==d||0==e||null==gameContent.grid[d]||null==gameContent.grid[d][e]||d==gameContent.grid[0].length-1||e==gameContent.grid.length-1||gameContent.grid[d][e]>0||null!=gameSurface.fogOfWarMatrix[d]&&!gameSurface.fogOfWarMatrix[d][e])&&(a.canBeBuiltHere=!1,a.shape[d-b.x][e-b.y]=userInput.CANNOT_BE_BUILT_HERE)},utils.getElementFromId=function(a){return gameContent.gameElements[Object.keys(gameData.FAMILIES)[(""+a)[1]]][a]},utils.copyValuesToObject=function(a,b){if(null==a||"object"!=typeof a)return a;for(var c in a)console.log(c),void 0==b[c]&&(b[c]={}),b[c]=utils.copyValuesToObject(a[c],b[c]);return b};var socketManager={};socketManager.socket=null,socketManager.connect=function(){this.socket=io.connect("war.gcorp.io/api"),this.socket.on("data",function(a){socketManager.onDataSocket(a)}),this.socket.on("gameData",function(a){socketManager.onGameDataSocket(a)})},socketManager.onDataSocket=function(a){switch(a.type){case gameData.TO_CLIENT_SOCKET.login:this.sendSocketToServer(gameData.TO_SERVER_SOCKET.login,gameManager.playerId);break;case gameData.TO_CLIENT_SOCKET.listJoinableGames:gameManager.updateJoinableGamesList(a);break;case gameData.TO_CLIENT_SOCKET.gameStart:gameManager.initOnlineGame(a);break;case gameData.TO_CLIENT_SOCKET.rejoin:gameManager.askRejoin(a);break;case gameData.TO_CLIENT_SOCKET.updateLoadingProgress:gameManager.updateLoadingQueue(a);break;case gameData.TO_CLIENT_SOCKET.updateQueue:gameManager.updateQueue(a);break;case gameData.TO_CLIENT_SOCKET.gameStats:gameManager.showStats(a.playerStatus,a.stats)}},socketManager.onGameDataSocket=function(a){gameContent.update(a)},socketManager.createNewGame=function(a){this.sendSocketToServer(gameData.TO_SERVER_SOCKET.createNewGame,a)},socketManager.enterSalon=function(){this.sendSocketToServer(gameData.TO_SERVER_SOCKET.enterSalon,null)},socketManager.leaveSalon=function(){this.sendSocketToServer(gameData.TO_SERVER_SOCKET.leaveSalon,null)},socketManager.joinGame=function(a,b,c,d){var e={playerId:a,playerName:b,gameId:c,armyId:d};this.sendSocketToServer(gameData.TO_SERVER_SOCKET.joinGame,e)},socketManager.updateLoadingProgress=function(a,b,c){var d={playerId:a,gameId:b,loadingProgress:c};this.sendSocketToServer(gameData.TO_SERVER_SOCKET.updateLoadingProgress,d)},socketManager.sendOrder=function(a,b,c){var d={gameId:a,type:b,params:c};this.sendSocketToServer(gameData.TO_SERVER_SOCKET.sendOrder,d)},socketManager.sendSocketToServer=function(a,b){this.socket.emit(a,b)},socketManager.rejoinGame=function(a,b){var c={playerId:a,gameId:b};this.sendSocketToServer(gameData.TO_SERVER_SOCKET.rejoinGame,c)};var gameManager={};gameManager.isOfflineGame=!1,gameManager.offlineGameLoop=0,gameManager.musicEnabled=!1,gameManager.getPlayerId=function(){var a=utils.readCookie("rts_player_id");if(null==a){var b=(new Date).getTime()+Math.random();utils.createCookie("rts_player_id",b),a=b}return a},gameManager.getPlayerName=function(){var a=utils.readCookie("rts_player_name");return null==a?gameData.getRandomName():a},gameManager.updatePlayerName=function(a){utils.createCookie("rts_player_name",a),this.playerName=a},gameManager.sendOrderToEngine=function(a,b){this.isOfflineGame?gameContent.game.orders.push([a,b]):socketManager.sendOrder(gameContent.gameId,a,b)},gameManager.createGameObject=function(a,b,c,d,e,f,g,h,i,j){return{playerId:a,playerName:b,armyId:c,mapType:d,mapSize:e,initialResources:f,vegetation:g,objectives:h,nbPlayers:i,iaPlayers:j}},gameManager.startOfflineGame=function(a){this.isOfflineGame=!0,gameContent.myArmy=a.armyId,gameContent.players=[],gameContent.players.push(new gameData.Player(0,0,a.armyId,!1)),gameContent.players[0].n=a.playerName;for(var b=0;b<a.iaPlayers.length;b++){var c=b+1;gameContent.players.push(new gameData.Player(c,c,a.iaPlayers[b],!0)),gameContent.players[c].n=gameData.getRandomName()}gameContent.map=new gameData.Map(gameData.MAP_TYPES[Object.keys(gameData.MAP_TYPES)[a.mapType]],gameData.MAP_SIZES[Object.keys(gameData.MAP_SIZES)[a.mapSize]],gameData.VEGETATION_TYPES[Object.keys(gameData.VEGETATION_TYPES)[a.vegetation]],gameData.INITIAL_RESOURCES[Object.keys(gameData.INITIAL_RESOURCES)[a.initialResources]],a.objectives),gameContent.game=gameCreation.createNewGame(gameContent.map,gameContent.players),this.waitingData=gameContent.game.gameElements,gameSurface.init(),GUI.init()},gameManager.updateLoadingProgress=function(a){$(".bar","#loadingProgress").css("width",a+"%"),this.isOfflineGame||gameContent.isRunning?a>=100&&this.startGame():(a>=100||Math.random()<.2)&&socketManager.updateLoadingProgress(this.playerId,gameContent.gameId,a)},gameManager.startGame=function(){setTimeout(function(){$("#game").removeClass("hide"),$("#loadingScreen").remove()},500),gameContent.init(this.waitingData),this.isOfflineGame&&0==this.offlineGameLoop&&(this.offlineGameLoop=setInterval(function(){gameContent.update(gameContent.game.update())},1e3/gameLogic.OFFLINE_FREQUENCY))},gameManager.updateJoinableGamesList=function(a){if($("tbody","#lstGames").html(""),a.games.length>0){$(".noResult","#joinGame").addClass("hide"),$("table","#joinGame").removeClass("hide");for(var b in a.games){var c=a.games[b];$("tbody","#lstGames").append('<tr data-id="'+c.id+'"><td>'+c.creatorName+"</td><td>"+c.mapSize+"</td><td>"+c.initialResources+"</td><td>"+c.objectives+"</td><td>"+c.players+"</td></tr>")}}else $(".noResult","#joinGame").removeClass("hide"),$("table","#joinGame").addClass("hide");$("tbody tr","#lstGames").click(function(){soundManager.playSound(soundManager.SOUNDS_LIST.mainButton),$(this).unbind("click"),$(".modal").modal("hide"),showLoadingScreen("Loading");var a=$(this).attr("data-id"),b=$(".checked","#armies").attr("data-army");socketManager.joinGame(gameManager.playerId,gameManager.playerName,a,b),requestFullScreen(),removeWebsiteDom()})},gameManager.initOnlineGame=function(a){gameContent.gameId=a.gameId,gameContent.players=a.players,gameContent.myArmy=a.myArmy,gameContent.map=a.map,gameContent.isRunning=a.isRunning,this.waitingData=a.initElements,gameSurface.init(),GUI.init()},gameManager.updateQueue=function(a){$("#playersLoading").removeClass("hide").html("");for(var b in a.players){var c=a.players[b];this.playerId!=c.pid&&$("#playersLoading").append('<div data-id="'+c.pid+'"><div class="color '+gameSurface.PLAYERS_COLORS[b]+'">&nbsp;</div><div class="name">'+c.n+'</div><div class="progress"><div class="bar" style="width: 0%"></div></div></div>')}},gameManager.playersReady=[],gameManager.updateLoadingQueue=function(a){$("#labelLoading").html("Loading"),$(".bar",'div[data-id="'+a.playerId+'"]').css("width",a.loadingProgress+"%"),a.loadingProgress>=100&&-1==this.playersReady.indexOf(a.playerId)&&this.playersReady.push(a.playerId),this.playersReady.length>=gameContent.players.length&&this.startGame()},gameManager.showStats=function(a,b){a==gameData.PLAYER_STATUSES.victory?($("#endGameMessage").addClass("victory"),$("#endGameMessage").html("Victory !")):($("#endGameMessage").addClass("defeat"),$("#endGameMessage").html("Defeat...")),$("#endGame").removeClass("hide");var c=[];for(var d in b){var e=b[d],f=gameContent.players[d],g=[];for(var d in f.tec){var h=f.tec[d];-1==g.indexOf(h)&&g.push(h)}var i=stats.getTotalScore(e,g.length);$("tbody","#endGame").append('<tr class="'+gameSurface.PLAYERS_COLORS[f.o]+'"><td>'+f.n+"</td><td>"+e.killed+"</td><td>"+e.lost+"</td><td>"+e.buildingsDestroyed+"</td><td>"+e.unitsCreated+"</td><td>"+e.resources+"</td><td>"+e.buildersCreated+"</td><td>"+e.buildingsCreated+"</td><td>"+g.length+"</td><td>"+i+"</td></tr>"),c.push(e.pop)}var j={xaxis:{show:!1},yaxis:{min:0,autoscaleMargin:1,position:"right",tickDecimals:0},colors:gameSurface.PLAYERS_COLORS};$("#popChart").css({height:"160px",width:window.innerWidth/2,left:window.innerWidth/4}),$.plot($("#popChart"),c,j)},gameManager.askRejoin=function(a){$("#notifications").removeClass("hide").append('<div class="notification rejoin blackBackground">You were in a game. Do you want to rejoin it ?<div><button class="ok green">Yes</button><button class="no red">No</button></div></div>'),$(".ok",".rejoin").click(function(){$(this).unbind("click"),$(".modal").modal("hide"),removeWebsiteDom(),showLoadingScreen("Loading"),socketManager.rejoinGame(gameManager.playerId,a.gameId),$(".rejoin").fadeOut()}),$(".no",".rejoin").click(function(){$(".rejoin").fadeOut()})};var soundManager={};soundManager.MUSIC_FILES_PATH="music/",soundManager.MUSICS_LIST=["main_theme"],soundManager.SOUNDS_LIST={mainButton:"main_button",button:"button",hammer:"hammer",saw:"saw",chainsaw:"chainsaw"},soundManager.MUSIC_VOLUME=.8,soundManager.SOUND_VOLUME=1,soundManager.audioFilesFormat=null,soundManager.musicTag=null,soundManager.soundTag=null,soundManager.init=function(){try{this.musicTag=$("audio","#musicTags")[0],this.soundTag=$("audio","#musicTags")[1],""!=this.musicTag.canPlayType("audio/ogg")?this.audioFilesFormat=".ogg":""!=this.musicTag.canPlayType("audio/mp3")&&(this.audioFilesFormat=".mp3"),this.musicTag.addEventListener("ended",function(){soundManager.musicTag.src=null,soundManager.playMusic()}),this.musicTag.volume=this.MUSIC_VOLUME,this.soundTag.volume=this.SOUND_VOLUME}catch(a){}},soundManager.playMusic=function(){gameManager.musicEnabled&&null!=this.audioFilesFormat&&((null==this.musicTag.src||""==this.musicTag.src)&&(this.musicTag.src=this.MUSIC_FILES_PATH+"ms_"+this.getRandomMusic()+this.audioFilesFormat),this.musicTag.play())},soundManager.stopMusic=function(){null!=this.audioFilesFormat&&(this.musicTag.pause(),this.soundTag.pause())},soundManager.playSound=function(a){gameManager.musicEnabled&&null!=this.audioFilesFormat&&(this.soundTag.src=this.MUSIC_FILES_PATH+"so_"+a+this.audioFilesFormat,this.soundTag.play())},soundManager.getRandomMusic=function(){return this.MUSICS_LIST[parseInt(Math.random()*this.MUSICS_LIST.length)]},centerMainButtons(),preloadImages(),$("input","#playerName").val(gameManager.getPlayerName()),$("input","#playerName").change(function(){gameManager.updatePlayerName($(this).val())}),$("input","#playerName").click(function(){$(this).select()}),$("input","#playerName").keydown(function(a){13==a.which&&$(this).blur()}),gameManager.playerId=gameManager.getPlayerId(),gameManager.playerName=gameManager.getPlayerName();try{socketManager.connect()}catch(e){}window.addEventListener("resize",centerMainButtons,!1),soundManager.init(),"true"==utils.readCookie("rts_music_enabled")&&(gameManager.musicEnabled=!0,$("#music").addClass("musicEnabled").html("On"),soundManager.playMusic()),$("#music").click(function(){gameManager.musicEnabled=!gameManager.musicEnabled,gameManager.musicEnabled?($("#music").addClass("musicEnabled").html("On"),soundManager.playMusic()):($("#music").removeClass("musicEnabled").html("Off"),soundManager.stopMusic()),utils.createCookie("rts_music_enabled",gameManager.musicEnabled)}),$(".customRadio","#armies").click(function(){$(this).attr("data-army")==gameData.RACES.human.id?($("#human").removeClass("hideI"),$("#lemons").addClass("hideI")):$(this).attr("data-army")==gameData.RACES.lemons.id&&($("#lemons").removeClass("hideI"),$("#human").addClass("hideI"))}),initMapTypes(),initMapSizes(),initVegetations(),initMapInitialResources(),initVictoryConditions(),$(".description","#tabVictory").html(gameData.VICTORY_CONDITIONS.annihilation.description),$("#vc1").change(function(){$(".description","#tabVictory").html(gameData.VICTORY_CONDITIONS[Object.keys(gameData.VICTORY_CONDITIONS)[$(this).val()]].description)}),initPlayers(),$(".customRadio","#players").click(function(){1==$(this).attr("data-value")?$(".aiArmy",$(this).parent()).removeClass("hide"):$(".aiArmy",$(this).parent()).addClass("hide")}),$("#nbPlayers").change(function(){updatePlayers($(this).val())}),isWebGLEnabled()||$("#errorWebGL").modal("show"),$(".cancelButton").click(function(){soundManager.playSound(soundManager.SOUNDS_LIST.mainButton),$(".modal").modal("hide")}),$("#createGameButton").click(function(){soundManager.playSound(soundManager.SOUNDS_LIST.mainButton),$("#newGame").modal("show")}),$("#tutorialButton").click(function(){soundManager.playSound(soundManager.SOUNDS_LIST.mainButton),$(this).unbind("click"),showLoadingScreen("Loading");var a=parseInt($(".checked","#armies").attr("data-army")),b=gameData.MAP_TYPES.standard.id,c=gameData.MAP_SIZES.small.id,d=gameData.INITIAL_RESOURCES.standard.id,e=gameData.VEGETATION_TYPES.standard.id,f=$("#vc1").val(),g=2,h=[gameData.RACES.human.id],i=gameManager.createGameObject(gameManager.playerId,gameManager.playerName,a,b,c,d,e,f,g,h);requestFullScreen(),gameManager.startOfflineGame(i),removeWebsiteDom()}),$("#confirmGameCreation").click(function(){soundManager.playSound(soundManager.SOUNDS_LIST.mainButton),$(this).unbind("click"),$(".modal").modal("hide"),showLoadingScreen("Waiting for opponents");var a=parseInt($(".checked","#armies").attr("data-army")),b=parseInt($("#mapType").val()),c=parseInt($("#mapSize").val()),d=parseInt($("#initialResources").val()),e=parseInt($("#vegetation").val()),f=$("#vc1").val(),g=parseInt($("#nbPlayers").val()),h=[];$.each($(".player","#players"),function(){$(this).hasClass("hideI")||1!=$(".checked",this).attr("data-value")||h.push(parseInt($(".aiArmy",$(this)).val()))});var i=gameManager.createGameObject(gameManager.playerId,gameManager.playerName,a,b,c,d,e,f,g,h);g-1==h.length?gameManager.startOfflineGame(i):socketManager.createNewGame(i),requestFullScreen(),removeWebsiteDom()}),$("#joinGameButton").click(function(){soundManager.playSound(soundManager.SOUNDS_LIST.mainButton),$("#joinGame").modal("show"),$(".noResult","#joinGame").removeClass("hide"),$("table","#joinGame").addClass("hide"),socketManager.enterSalon()}),$("#joinGame").on("hidden",function(){socketManager.leaveSalon()}),$(".customRadio").click(function(){$('.customRadio[data-name="'+$(this).attr("data-name")+'"]').removeClass("checked"),$(this).addClass("checked")}),$('a[data-toggle="tab"]').on("shown",function(a){$("#newGame").css({background:"#3b423c",background:"-moz-radial-gradient(center, ellipse cover, #3b423c 1%, #000000 100%)",background:"-webkit-gradient(radial, center center, 0px, center center, 100%, color-stop(1%,#3b423c), color-stop(100%,#000000))",background:"-webkit-radial-gradient(center, ellipse cover, #3b423c 1%,#000000 100%)"})});